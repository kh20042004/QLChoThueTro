<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéì Tr∆∞·ªùng ƒê·∫°i H·ªçc - HomeRent</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6B7280',
                        secondary: '#9CA3AF',
                        accent: '#4B5563',
                        light: '#F9FAFB',
                        dark: '#1F2937'
                    },
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif']
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Custom animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .animate-fadeInUp {
            animation: fadeInUp 0.6s ease-out;
        }
        
        .animate-fadeIn {
            animation: fadeIn 0.8s ease-out;
        }
        
        .animate-slideDown {
            animation: slideDown 0.3s ease-out;
        }
        
        .delay-100 { animation-delay: 0.1s; }
        .delay-200 { animation-delay: 0.2s; }
        .delay-300 { animation-delay: 0.3s; }
        
        /* Smooth scroll */
        html { scroll-behavior: smooth; }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #F3F4F6;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #9CA3AF;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #6B7280;
        }
        
        /* Line clamp for description */
        .line-clamp-4 {
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>
<body class="font-sans text-gray-800">
    <!-- Radial Gradient Background -->
    <div class="fixed inset-0 w-full h-full z-0" style="background: radial-gradient(125% 125% at 50% 10%, #fff 40%, #1d2125 100%);"></div>
    
    <!-- Content Wrapper -->
    <div class="relative z-10">
        <!-- Header -->
        <header class="sticky top-0 z-50 bg-white/80 backdrop-blur-md shadow-sm">
            <nav class="container mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <!-- Logo -->
                    <a href="/" class="flex items-center space-x-2 group">
                        <i class="fas fa-home text-2xl text-gray-600 group-hover:text-gray-800 transition-colors duration-300"></i>
                        <span class="text-xl font-bold text-gray-800">HomeRent</span>
                    </a>
                    
                    <!-- Desktop Menu -->
                    <div class="hidden md:flex items-center space-x-8">
                        <a href="/" class="text-gray-700 hover:text-gray-900 transition-colors duration-300 relative group">
                            Trang ch·ªß
                            <span class="absolute bottom-0 left-0 w-0 h-0.5 bg-gray-800 group-hover:w-full transition-all duration-300"></span>
                        </a>
                        <a href="/properties" class="text-gray-700 hover:text-gray-900 transition-colors duration-300 relative group">
                            T√¨m ph√≤ng
                            <span class="absolute bottom-0 left-0 w-0 h-0.5 bg-gray-800 group-hover:w-full transition-all duration-300"></span>
                        </a>
                        <a href="/universities" class="text-gray-900 font-semibold transition-colors duration-300 relative group">
                            üéì Tr∆∞·ªùng ƒêH
                            <span class="absolute bottom-0 left-0 w-full h-0.5 bg-gray-800"></span>
                        </a>
                        <a href="/about" class="text-gray-700 hover:text-gray-900 transition-colors duration-300 relative group">
                            Gi·ªõi thi·ªáu
                            <span class="absolute bottom-0 left-0 w-0 h-0.5 bg-gray-800 group-hover:w-full transition-all duration-300"></span>
                        </a>
                        <a href="/contact" class="text-gray-700 hover:text-gray-900 transition-colors duration-300 relative group">
                            Li√™n h·ªá
                            <span class="absolute bottom-0 left-0 w-0 h-0.5 bg-gray-800 group-hover:w-full transition-all duration-300"></span>
                        </a>
                    </div>
                    
                    <!-- Auth Buttons -->
                    <div class="hidden md:flex items-center space-x-3" id="navbarGuest">
                        <a href="/auth/login" class="px-4 py-2 text-gray-700 hover:text-gray-900 transition-colors duration-300">
                            <i class="fas fa-sign-in-alt mr-1"></i>ƒêƒÉng nh·∫≠p
                        </a>
                        <a href="/auth/register" class="px-5 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition-all duration-300">
                            <i class="fas fa-user-plus mr-1"></i>ƒêƒÉng k√Ω
                        </a>
                    </div>
                    
                    <!-- User Menu (Logged in) -->
                    <div class="hidden md:flex items-center space-x-4" id="navbarUser" style="display: none;">
                        <!-- Notifications -->
                        <a href="/notifications" class="relative p-2 text-gray-600 hover:text-gray-900 transition-colors duration-300" title="Th√¥ng b√°o">
                            <i class="fas fa-bell text-xl"></i>
                            <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs w-5 h-5 flex items-center justify-center rounded-full">3</span>
                        </a>
                        
                        <!-- Favorites -->
                        <a href="/favorites" class="relative p-2 text-gray-600 hover:text-gray-900 transition-colors duration-300" title="Y√™u th√≠ch">
                            <i class="fas fa-heart text-xl"></i>
                            <span id="favoriteBadge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs w-5 h-5 flex items-center justify-center rounded-full">0</span>
                        </a>
                        
                        <!-- Post Property -->
                        <a href="/property/create" class="px-5 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition-all duration-300 shadow-sm hover:shadow-md" title="ƒêƒÉng tin">
                            <i class="fas fa-plus mr-1"></i>ƒêƒÉng tin
                        </a>
                        
                        <!-- User Dropdown -->
                        <div class="relative group">
                            <button class="flex items-center space-x-2">
                                <img src="https://via.placeholder.com/40/6B7280/ffffff?text=U" alt="Avatar" class="w-8 h-8 rounded-full border-2 border-gray-300" id="userAvatar">
                                <span class="text-gray-700" id="userName">Ng∆∞·ªùi d√πng</span>
                                <i class="fas fa-chevron-down text-xs text-gray-500"></i>
                            </button>
                            <div class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 z-50">
                                <a href="/profile" class="block px-4 py-2 text-gray-700 hover:bg-gray-100 transition-colors">
                                    <i class="fas fa-user-circle mr-2"></i>H·ªì s∆° c√° nh√¢n
                                </a>
                                <a href="/my-properties" class="block px-4 py-2 text-gray-700 hover:bg-gray-100 transition-colors">
                                    <i class="fas fa-home mr-2"></i>Tin c·ªßa t√¥i
                                </a>
                                <a href="/transaction-history" class="block px-4 py-2 text-gray-700 hover:bg-gray-100 transition-colors">
                                    <i class="fas fa-history mr-2"></i>L·ªãch s·ª≠ giao d·ªãch
                                </a>
                                <a href="/recharge-history" class="block px-4 py-2 text-gray-700 hover:bg-gray-100 transition-colors">
                                    <i class="fas fa-wallet mr-2"></i>L·ªãch s·ª≠ n·∫°p ti·ªÅn
                                </a>
                                <hr class="my-2">
                                <a href="/logout" onclick="handleLogout(event)" class="block px-4 py-2 text-red-600 hover:bg-red-50 transition-colors">
                                    <i class="fas fa-sign-out-alt mr-2"></i>ƒêƒÉng xu·∫•t
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mobile Menu Button -->
                    <button class="md:hidden text-gray-700" id="mobileMenuBtn">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
                
                <!-- Mobile Menu -->
                <div class="hidden md:hidden mt-4 pb-4 border-t border-gray-100" id="mobileMenu">
                    <div class="flex flex-col space-y-3 mt-4">
                        <a href="/" class="text-gray-700 hover:text-gray-900 py-2">Trang ch·ªß</a>
                        <a href="/properties" class="text-gray-700 hover:text-gray-900 py-2">T√¨m ph√≤ng</a>
                        <a href="/universities" class="text-gray-900 font-semibold py-2">üéì Tr∆∞·ªùng ƒêH</a>
                        <a href="/about" class="text-gray-700 hover:text-gray-900 py-2">Gi·ªõi thi·ªáu</a>
                        <a href="/contact" class="text-gray-700 hover:text-gray-900 py-2">Li√™n h·ªá</a>
                        
                        <!-- Mobile Auth -->
                        <div id="mobileAuthGuest" class="border-t border-gray-200 pt-3 mt-3 space-y-2">
                            <a href="/auth/login" class="block px-4 py-2 text-gray-700 hover:text-gray-900">
                                <i class="fas fa-sign-in-alt mr-1"></i>ƒêƒÉng nh·∫≠p
                            </a>
                            <a href="/auth/register" class="block px-4 py-2 bg-gray-800 text-white rounded-lg text-center">
                                <i class="fas fa-user-plus mr-1"></i>ƒêƒÉng k√Ω
                            </a>
                        </div>
                        
                        <!-- Mobile User Menu -->
                        <div id="mobileAuthUser" style="display: none;" class="border-t border-gray-200 pt-3 mt-3 space-y-2">
                            <a href="/notifications" class="flex items-center py-2 text-gray-700 hover:text-gray-900">
                                <i class="fas fa-bell mr-2"></i>Th√¥ng b√°o
                            </a>
                            <a href="/favorites" class="flex items-center py-2 text-gray-700 hover:text-gray-900">
                                <i class="fas fa-heart mr-2"></i>Y√™u th√≠ch
                            </a>
                            <a href="/property/create" class="flex items-center py-2 text-gray-700 hover:text-gray-900">
                                <i class="fas fa-plus mr-2"></i>ƒêƒÉng tin
                            </a>
                            <a href="/profile" class="flex items-center py-2 text-gray-700 hover:text-gray-900">
                                <i class="fas fa-user-circle mr-2"></i>H·ªì s∆° c√° nh√¢n
                            </a>
                            <a href="/my-properties" class="flex items-center py-2 text-gray-700 hover:text-gray-900">
                                <i class="fas fa-home mr-2"></i>Tin c·ªßa t√¥i
                            </a>
                            <a href="/transaction-history" class="flex items-center py-2 text-gray-700 hover:text-gray-900">
                                <i class="fas fa-history mr-2"></i>L·ªãch s·ª≠ giao d·ªãch
                            </a>
                            <a href="/recharge-history" class="flex items-center py-2 text-gray-700 hover:text-gray-900">
                                <i class="fas fa-wallet mr-2"></i>L·ªãch s·ª≠ n·∫°p ti·ªÅn
                            </a>
                            <a href="/logout" onclick="handleLogout(event)" class="flex items-center py-2 text-red-600 hover:text-red-700">
                                <i class="fas fa-sign-out-alt mr-2"></i>ƒêƒÉng xu·∫•t
                            </a>
                        </div>
                    </div>
                </div>
            </nav>
        </header>

        <!-- Hero Section -->
        <section class="py-16 bg-gradient-to-br from-gray-600 to-gray-800 text-white">
            <div class="container mx-auto px-4 text-center">
                <h1 class="text-4xl md:text-5xl font-bold mb-4 animate-fadeInUp">üéì Tr∆∞·ªùng ƒê·∫°i H·ªçc TP.HCM</h1>
                <p class="text-lg text-gray-300 animate-fadeInUp delay-100">T√¨m ki·∫øm tr∆∞·ªùng ƒë·∫°i h·ªçc v√† ph√≤ng tr·ªç g·∫ßn tr∆∞·ªùng b·∫°n mong mu·ªën</p>
            </div>
        </section>

        <!-- Breadcrumb -->
        <div class="bg-gray-100 py-3 border-b border-gray-200">
            <div class="container mx-auto px-4">
                <nav class="flex items-center gap-2 text-sm text-gray-600">
                    <a href="/" class="hover:text-gray-900">Trang ch·ªß</a>
                    <span>/</span>
                    <span class="text-gray-900 font-semibold">Tr∆∞·ªùng ƒê·∫°i H·ªçc</span>
                </nav>
            </div>
        </div>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-12">
            <!-- Filters Section -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8 animate-fadeInUp">
                <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
                    <i class="fas fa-filter text-gray-600"></i>
                    T√¨m Ki·∫øm & L·ªçc
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <!-- Search Input with Autocomplete -->
                    <div class="relative">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">T√™n tr∆∞·ªùng ho·∫∑c ng√†nh h·ªçc</label>
                        <input 
                            type="text" 
                            id="searchInput" 
                            placeholder="Nh·∫≠p t√™n tr∆∞·ªùng..."
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-gray-800 transition"
                            autocomplete="off"
                        >
                        <!-- Autocomplete Dropdown -->
                        <div 
                            id="autocompleteDropdown" 
                            class="hidden absolute top-full left-0 right-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg z-10 max-h-60 overflow-y-auto"
                        ></div>
                    </div>
                    
                    <!-- District Filter -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Qu·∫≠n</label>
                        <select 
                            id="districtFilter"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-gray-800 transition"
                        >
                            <option value="">-- T·∫•t c·∫£ qu·∫≠n --</option>
                        </select>
                    </div>
                    
                    <!-- Specialty Filter -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Ng√†nh h·ªçc</label>
                        <select 
                            id="specialtyFilter"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-gray-800 transition"
                        >
                            <option value="">-- T·∫•t c·∫£ ng√†nh --</option>
                        </select>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex gap-3">
                    <button 
                        onclick="searchUniversities()"
                        class="flex-1 px-6 py-3 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition font-semibold"
                    >
                        <i class="fas fa-search mr-2"></i>T√¨m Ki·∫øm
                    </button>
                    <button 
                        onclick="resetFilters()"
                        class="flex-1 px-6 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition font-semibold"
                    >
                        <i class="fas fa-redo mr-2"></i>ƒê·∫∑t L·∫°i
                    </button>
                </div>
            </div>

            <!-- Universities Grid -->
            <div id="universitiesGrid" class="space-y-6 mb-12">
                <div class="text-center py-12">
                    <div class="text-gray-500">
                        <i class="fas fa-spinner fa-spin text-3xl mb-4"></i>
                        <p class="text-lg">ƒêang t·∫£i d·ªØ li·ªáu...</p>
                    </div>
                </div>
            </div>

            <!-- Pagination Info & Buttons -->
            <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-12">
                <div id="paginationInfo" class="text-gray-600 text-sm"></div>
                <div id="paginationContainer" class="flex justify-center gap-2 flex-wrap"></div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-900/95 backdrop-blur-sm pt-12 pb-6 text-gray-300">
            <div class="container mx-auto px-4">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-8 mb-8">
                    <!-- Brand -->
                    <div>
                        <h3 class="text-white font-bold text-lg mb-4">HomeRent</h3>
                        <p class="text-sm text-gray-400">N·ªÅn t·∫£ng cho thu√™ nh√†/ph√≤ng tr·ªç h√†ng ƒë·∫ßu t·∫°i TP.HCM</p>
                    </div>
                    
                    <!-- Links -->
                    <div>
                        <h4 class="font-semibold text-white mb-4">Li√™n K·∫øt</h4>
                        <ul class="space-y-2 text-sm">
                            <li><a href="/" class="text-gray-400 hover:text-white transition">Trang ch·ªß</a></li>
                            <li><a href="/properties" class="text-gray-400 hover:text-white transition">T√¨m ph√≤ng</a></li>
                            <li><a href="/about" class="text-gray-400 hover:text-white transition">Gi·ªõi thi·ªáu</a></li>
                            <li><a href="/contact" class="text-gray-400 hover:text-white transition">Li√™n h·ªá</a></li>
                        </ul>
                    </div>
                    
                    <!-- Support -->
                    <div>
                        <h4 class="font-semibold text-white mb-4">H·ªó Tr·ª£</h4>
                        <ul class="space-y-2 text-sm">
                            <li><a href="/faq" class="text-gray-400 hover:text-white transition">C√¢u h·ªèi th∆∞·ªùng g·∫∑p</a></li>
                            <li><a href="/guide" class="text-gray-400 hover:text-white transition">H∆∞·ªõng d·∫´n</a></li>
                            <li><a href="/terms" class="text-gray-400 hover:text-white transition">ƒêi·ªÅu kho·∫£n</a></li>
                            <li><a href="/privacy" class="text-gray-400 hover:text-white transition">B·∫£o m·∫≠t</a></li>
                        </ul>
                    </div>
                    
                    <!-- Social -->
                    <div>
                        <h4 class="font-semibold text-white mb-4">Theo D√µi</h4>
                        <div class="flex space-x-4">
                            <a href="#" class="text-gray-400 hover:text-white transition"><i class="fab fa-facebook text-xl"></i></a>
                            <a href="#" class="text-gray-400 hover:text-white transition"><i class="fab fa-twitter text-xl"></i></a>
                            <a href="#" class="text-gray-400 hover:text-white transition"><i class="fab fa-instagram text-xl"></i></a>
                            <a href="#" class="text-gray-400 hover:text-white transition"><i class="fab fa-youtube text-xl"></i></a>
                        </div>
                    </div>
                </div>
                
                <div class="border-t border-gray-800 pt-6 text-center text-sm text-gray-400">
                    <p>&copy; 2024 HomeRent. T·∫•t c·∫£ quy·ªÅn ƒë∆∞·ª£c b·∫£o l∆∞u.</p>
                </div>
            </div>
        </footer>
    </div>

    <!-- Modal Detail -->
    <div id="detailModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- Modal: Ph√≤ng tr·ªç g·∫ßn tr∆∞·ªùng -->
    <div id="nearbyRoomsModal" class="fixed inset-0 z-50 hidden">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-black bg-opacity-50 backdrop-blur-sm" id="nearbyRoomsBackdrop"></div>
        
        <!-- Modal Content -->
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-hidden animate-fadeInUp">
                <!-- Header -->
                <div class="bg-gradient-to-r from-gray-800 to-gray-700 text-white px-6 py-4 flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-university text-xl"></i>
                        <h3 class="text-xl font-bold" id="nearbyModalTitle">Ph√≤ng tr·ªç g·∫ßn tr∆∞·ªùng</h3>
                    </div>
                    <button id="closeNearbyRoomsModal" class="text-white hover:text-gray-200 transition-colors duration-200">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <!-- Body -->
                <div class="p-6">
                    <!-- Loading State -->
                    <div id="nearbyRoomsLoading" class="text-center py-12">
                        <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-gray-200 border-t-gray-800"></div>
                        <p class="mt-4 text-gray-600">ƒêang t·∫£i danh s√°ch ph√≤ng tr·ªç...</p>
                    </div>
                    
                    <!-- Error State -->
                    <div id="nearbyRoomsError" class="hidden text-center py-12">
                        <i class="fas fa-exclamation-triangle text-5xl text-yellow-500 mb-4"></i>
                        <h4 class="text-xl font-semibold text-gray-800 mb-2">Kh√¥ng th·ªÉ t·∫£i danh s√°ch ph√≤ng</h4>
                        <p class="text-gray-600 mb-6" id="nearbyRoomsErrorMessage">Vui l√≤ng th·ª≠ l·∫°i sau.</p>
                        <button id="retryNearbyRooms" class="px-6 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition-colors duration-200">
                            <i class="fas fa-redo mr-2"></i>Th·ª≠ l·∫°i
                        </button>
                    </div>
                    
                    <!-- Map Container -->
                    <div id="nearbyRoomsMapContainer" class="hidden">
                        <!-- Info Bar -->
                        <div class="bg-gray-50 rounded-lg p-4 mb-4 flex items-center justify-between flex-wrap gap-2">
                            <div class="flex items-center space-x-4">
                                <div class="flex items-center space-x-2">
                                    <i class="fas fa-university text-gray-600"></i>
                                    <span class="text-sm text-gray-700">Tr∆∞·ªùng: <span id="universityNameText" class="font-semibold">...</span></span>
                                </div>
                                <div class="h-4 w-px bg-gray-300"></div>
                                <div class="flex items-center space-x-2">
                                    <i class="fas fa-home text-gray-600"></i>
                                    <span class="text-sm text-gray-700">T√¨m th·∫•y: <span id="nearbyRoomsCount" class="font-semibold text-gray-800">0</span> ph√≤ng</span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <label class="text-sm text-gray-700">B√°n k√≠nh:</label>
                                <select id="nearbyRoomsRadius" class="px-3 py-1 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-gray-400">
                                    <option value="1">1 km</option>
                                    <option value="2" selected>2 km</option>
                                    <option value="3">3 km</option>
                                    <option value="5">5 km</option>
                                    <option value="10">10 km</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Map -->
                        <div id="nearbyRoomsMap" class="w-full h-[500px] rounded-lg shadow-inner"></div>
                        
                        <!-- Properties List -->
                        <div class="mt-4">
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Danh s√°ch ph√≤ng tr·ªç g·∫ßn tr∆∞·ªùng</h4>
                            <div id="nearbyRoomsPropertyList" class="max-h-64 overflow-y-auto space-y-2">
                                <!-- Properties will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <script>
        const ITEMS_PER_PAGE = 12;
        let currentPage = 1;
        let allUniversities = [];
        let filteredUniversities = [];

        // Check if user is logged in
        function checkUserStatus() {
            const token = localStorage.getItem('token');
            if (token) {
                document.getElementById('navbarGuest').style.display = 'none';
                document.getElementById('navbarUser').style.display = 'flex';
                document.getElementById('mobileAuthGuest').style.display = 'none';
                document.getElementById('mobileAuthUser').style.display = 'block';
                
                // Load user info
                fetch('/api/auth/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                })
                .then(r => r.json())
                .then(data => {
                    if (data.success && data.data) {
                        document.getElementById('userName').textContent = data.data.name;
                        if (data.data.avatar) {
                            document.getElementById('userAvatar').src = data.data.avatar;
                        }
                    }
                })
                .catch(err => console.error('Error:', err));
                
                // Load favorites count
                loadFavoritesCount();
            }
        }

        // Load favorites count
        function loadFavoritesCount() {
            const token = localStorage.getItem('token');
            if (!token) return;

            fetch('/api/favorites', {
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(r => r.json())
            .then(data => {
                if (data.success && data.data) {
                    const count = Array.isArray(data.data) ? data.data.length : (data.data.length || 0);
                    document.getElementById('favoriteBadge').textContent = count;
                }
            })
            .catch(err => console.error('Error loading favorites:', err));
        }

        // Handle logout
        function handleLogout(e) {
            e.preventDefault();
            localStorage.removeItem('token');
            window.location.href = '/';
        }

        // Mobile menu toggle
        document.getElementById('mobileMenuBtn')?.addEventListener('click', function() {
            const mobileMenu = document.getElementById('mobileMenu');
            mobileMenu.classList.toggle('hidden');
        });

        // Load on page load
        document.addEventListener('DOMContentLoaded', async () => {
            checkUserStatus();
            await loadUniversities();
            await loadDistricts();
            await loadSpecialties();
        });

        // Load all universities
        async function loadUniversities() {
            try {
                const response = await fetch('/api/universities?limit=1000');
                const data = await response.json();
                allUniversities = data.data;
                filteredUniversities = allUniversities;
                displayUniversities();
                updatePagination();
                setupAutocomplete();
            } catch (error) {
                console.error('L·ªói:', error);
                document.getElementById('universitiesGrid').innerHTML = 
                    '<div class="col-span-full text-center py-12 text-red-500"><i class="fas fa-exclamation-circle text-3xl mb-4"></i><p>C√≥ l·ªói khi t·∫£i d·ªØ li·ªáu</p></div>';
            }
        }

        // Setup autocomplete
        function setupAutocomplete() {
            const searchInput = document.getElementById('searchInput');
            const autocompleteDropdown = document.getElementById('autocompleteDropdown');

            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();

                if (query.length === 0) {
                    autocompleteDropdown.classList.add('hidden');
                    return;
                }

                // Collect all suggestions (university names and specialties)
                const suggestions = new Set();
                
                allUniversities.forEach(uni => {
                    if (uni.name.toLowerCase().includes(query)) {
                        suggestions.add(uni.name);
                    }
                    uni.specialties.forEach(specialty => {
                        if (specialty.toLowerCase().includes(query)) {
                            suggestions.add(specialty);
                        }
                    });
                });

                if (suggestions.size === 0) {
                    autocompleteDropdown.classList.add('hidden');
                    return;
                }

                // Display suggestions
                const suggestionsArray = Array.from(suggestions).sort().slice(0, 8);
                autocompleteDropdown.innerHTML = suggestionsArray.map(suggestion => `
                    <div class="px-4 py-3 hover:bg-gray-100 cursor-pointer border-b border-gray-200 last:border-b-0 transition"
                         onclick="selectSuggestion('${suggestion}')">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-search text-gray-400 text-sm"></i>
                            <span class="text-gray-700">${suggestion}</span>
                        </div>
                    </div>
                `).join('');

                autocompleteDropdown.classList.remove('hidden');
            });

            // Hide dropdown when clicking outside
            document.addEventListener('click', function(event) {
                if (!event.target.closest('#searchInput') && !event.target.closest('#autocompleteDropdown')) {
                    autocompleteDropdown.classList.add('hidden');
                }
            });
        }

        // Select suggestion
        function selectSuggestion(suggestion) {
            document.getElementById('searchInput').value = suggestion;
            document.getElementById('autocompleteDropdown').classList.add('hidden');
            searchUniversities();
        }

        // Load districts
        async function loadDistricts() {
            try {
                const response = await fetch('/api/universities/districts/list');
                const data = await response.json();
                const select = document.getElementById('districtFilter');
                data.data.forEach(district => {
                    const option = document.createElement('option');
                    option.value = district;
                    option.textContent = district;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('L·ªói khi t·∫£i qu·∫≠n:', error);
            }
        }

        // Load specialties
        async function loadSpecialties() {
            try {
                const response = await fetch('/api/universities/specialties/list');
                const data = await response.json();
                const select = document.getElementById('specialtyFilter');
                data.data.forEach(specialty => {
                    const option = document.createElement('option');
                    option.value = specialty;
                    option.textContent = specialty;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('L·ªói khi t·∫£i ng√†nh:', error);
            }
        }

        // Search universities
        function searchUniversities() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const district = document.getElementById('districtFilter').value;
            const specialty = document.getElementById('specialtyFilter').value;

            filteredUniversities = allUniversities.filter(uni => {
                const matchSearch = !search ||
                    uni.name.toLowerCase().includes(search) ||
                    uni.description.toLowerCase().includes(search) ||
                    uni.specialties.some(s => s.toLowerCase().includes(search));

                const matchDistrict = !district || uni.district === district;
                const matchSpecialty = !specialty || uni.specialties.includes(specialty);

                return matchSearch && matchDistrict && matchSpecialty;
            });

            currentPage = 1;
            displayUniversities();
            updatePagination();
        }

        // Reset filters
        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('districtFilter').value = '';
            document.getElementById('specialtyFilter').value = '';
            filteredUniversities = allUniversities;
            currentPage = 1;
            displayUniversities();
            updatePagination();
        }

        // Display universities
        function displayUniversities() {
            const grid = document.getElementById('universitiesGrid');

            if (filteredUniversities.length === 0) {
                grid.innerHTML = '<div class="text-center py-12"><div class="text-gray-500"><i class="fas fa-inbox text-4xl mb-4"></i><p class="text-lg font-semibold">Kh√¥ng t√¨m th·∫•y tr∆∞·ªùng n√†o</p><p class="text-sm">Vui l√≤ng thay ƒë·ªïi b·ªô l·ªçc t√¨m ki·∫øm</p></div></div>';
                return;
            }

            const start = (currentPage - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const paginated = filteredUniversities.slice(start, end);

            grid.innerHTML = paginated.map(uni => `
                <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition overflow-hidden animate-fadeIn">
                    <div class="p-6">
                        <!-- Header with Ranking -->
                        <div class="flex items-start gap-4 mb-4">
                            <div class="flex-shrink-0">
                                <div class="w-12 h-12 bg-gray-800 text-white rounded-lg flex items-center justify-center font-bold text-lg">
                                    #${uni.ranking || '?'}
                                </div>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-bold text-xl text-gray-900 mb-2">${uni.name}</h3>
                                <div class="flex flex-wrap gap-2 mb-2">
                                    <span class="inline-block ${uni.type === 'C√¥ng l·∫≠p' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'} text-xs px-3 py-1 rounded-full font-semibold">${uni.type}</span>
                                    <span class="inline-block bg-gray-100 text-gray-700 text-xs px-3 py-1 rounded-full">${uni.shortName}</span>
                                    <span class="inline-block bg-gray-100 text-gray-700 text-xs px-3 py-1 rounded-full"><i class="fas fa-map-marker-alt mr-1"></i>${uni.district}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Description -->
                        <p class="text-gray-600 text-sm leading-relaxed mb-4 line-clamp-4">${uni.description || 'Ch∆∞a c√≥ m√¥ t·∫£'}</p>
                        
                        <!-- Info -->
                        <div class="space-y-2 mb-4 text-sm">
                            <p class="text-gray-600 flex items-start gap-2">
                                <i class="fas fa-map-marker-alt text-gray-800 mt-1"></i>
                                <span>${uni.address}</span>
                            </p>
                            <p class="text-gray-600 flex items-center gap-2">
                                <i class="fas fa-phone text-gray-800"></i>
                                <a href="tel:${uni.phone}" class="text-gray-800 hover:underline">${uni.phone}</a>
                            </p>
                        </div>
                        
                        <!-- Specialties -->
                        ${uni.specialties && uni.specialties.length > 0 ? `
                        <div class="mb-4">
                            <p class="text-xs font-semibold text-gray-700 mb-2">üéØ Ng√†nh h·ªçc n·ªïi b·∫≠t:</p>
                            <div class="flex flex-wrap gap-2">
                                ${uni.specialties.slice(0, 4).map(spec => `
                                    <span class="inline-block bg-gray-100 text-gray-700 text-xs px-2 py-1 rounded">${spec}</span>
                                `).join('')}
                                ${uni.specialties.length > 4 ? `<span class="inline-block bg-gray-100 text-gray-700 text-xs px-2 py-1 rounded">+${uni.specialties.length - 4} ng√†nh</span>` : ''}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- Actions -->
                    <div class="bg-gray-50 px-6 py-4 flex gap-2 border-t border-gray-200">
                        <button 
                            onclick="showDetail('${uni._id}')"
                            class="flex-1 px-3 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition text-sm font-semibold"
                        >
                            <i class="fas fa-info-circle mr-1"></i>Chi ti·∫øt
                        </button>
                        <button 
                            onclick="findNearbyRooms('${uni._id}')"
                            class="flex-1 px-3 py-2 bg-gray-800 text-white rounded hover:bg-gray-700 transition text-sm font-semibold"
                        >
                            <i class="fas fa-home mr-1"></i>T√¨m ph√≤ng
                        </button>
                    </div>
                </div>
            `).join('');

            // Update pagination info
            updatePaginationInfo();
        }

        // Update pagination info
        function updatePaginationInfo() {
            const info = document.getElementById('paginationInfo');
            const start = (currentPage - 1) * ITEMS_PER_PAGE + 1;
            const end = Math.min(currentPage * ITEMS_PER_PAGE, filteredUniversities.length);
            info.textContent = `Hi·ªÉn th·ªã ${start}-${end} trong t·ªïng s·ªë ${filteredUniversities.length} tr∆∞·ªùng`;
        }

        // Show detail
        async function showDetail(universityId) {
            try {
                const response = await fetch(`/api/universities/${universityId}`);
                const data = await response.json();
                const uni = data.data;

                const modalContent = document.getElementById('modalContent');
                
                let statsHtml = '';
                if (uni.foundedYear || uni.studentCount || uni.facultyCount) {
                    statsHtml = `
                        <div class="grid grid-cols-3 gap-4 mt-4 p-4 bg-gray-50 rounded-lg">
                            ${uni.foundedYear ? `<div class="text-center"><p class="text-gray-500 text-sm">NƒÉm th√†nh l·∫≠p</p><p class="text-xl font-bold text-gray-800">${uni.foundedYear}</p></div>` : ''}
                            ${uni.studentCount ? `<div class="text-center"><p class="text-gray-500 text-sm">Sinh vi√™n</p><p class="text-xl font-bold text-gray-800">${uni.studentCount.toLocaleString()}</p></div>` : ''}
                            ${uni.facultyCount ? `<div class="text-center"><p class="text-gray-500 text-sm">S·ªë khoa</p><p class="text-xl font-bold text-gray-800">${uni.facultyCount}</p></div>` : ''}
                        </div>
                    `;
                }

                // Programs section
                let programsHtml = '';
                if (uni.programs && uni.programs.length > 0) {
                    programsHtml = `
                        <div class="mt-6 pt-6 border-t border-gray-200">
                            <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                                <i class="fas fa-graduation-cap text-gray-600"></i>
                                Ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o & H·ªçc ph√≠ 2025
                            </h3>
                            <div class="space-y-4">
                                ${uni.programs.map(prog => `
                                    <div class="bg-blue-50 p-4 rounded-lg">
                                        <h4 class="font-semibold text-gray-900 mb-2">${prog.name}</h4>
                                        <p class="text-sm text-blue-800 font-semibold mb-2">üí∞ ${prog.tuition}</p>
                                        ${prog.description ? `<p class="text-xs text-gray-600 mb-2 italic">${prog.description}</p>` : ''}
                                        <div class="mt-2">
                                            <p class="text-xs font-semibold text-gray-700 mb-1">C√°c ng√†nh:</p>
                                            <div class="flex flex-wrap gap-1">
                                                ${prog.majors.slice(0, 5).map(major => `
                                                    <span class="text-xs bg-white text-gray-700 px-2 py-1 rounded">${major}</span>
                                                `).join('')}
                                                ${prog.majors.length > 5 ? `<span class="text-xs bg-white text-gray-700 px-2 py-1 rounded">+${prog.majors.length - 5} ng√†nh</span>` : ''}
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                // Admission Scores section
                let scoresHtml = '';
                if (uni.admissionScores && uni.admissionScores.length > 0) {
                    scoresHtml = `
                        <div class="mt-6 pt-6 border-t border-gray-200">
                            <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                                <i class="fas fa-chart-line text-gray-600"></i>
                                ƒêi·ªÉm chu·∫©n nƒÉm ${uni.admissionScores[0].year}
                            </h3>
                            <div class="max-h-64 overflow-y-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-100 sticky top-0">
                                        <tr>
                                            <th class="text-left p-2 font-semibold text-gray-700">Ng√†nh</th>
                                            <th class="text-right p-2 font-semibold text-gray-700">ƒêi·ªÉm</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${uni.admissionScores.map((score, idx) => `
                                            <tr class="${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                                                <td class="p-2 text-gray-800">${score.major}</td>
                                                <td class="p-2 text-right font-semibold text-blue-600">${score.score}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            <p class="text-xs text-gray-500 mt-2 italic">* ƒêi·ªÉm chu·∫©n ƒë√£ bao g·ªìm ƒëi·ªÉm ∆∞u ti√™n (n·∫øu c√≥)</p>
                        </div>
                    `;
                }

                // Admission Info section
                let admissionHtml = '';
                if (uni.admissionInfo && uni.admissionInfo.methods) {
                    admissionHtml = `
                        <div class="mt-6 pt-6 border-t border-gray-200">
                            <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                                <i class="fas fa-file-alt text-gray-600"></i>
                                Th√¥ng tin tuy·ªÉn sinh 2025
                            </h3>
                            ${uni.admissionInfo.description ? `<p class="text-sm text-gray-600 mb-3">${uni.admissionInfo.description}</p>` : ''}
                            
                            <div class="space-y-3">
                                <div>
                                    <p class="text-sm font-semibold text-gray-800 mb-2">üìã Ph∆∞∆°ng th·ª©c x√©t tuy·ªÉn:</p>
                                    <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                                        ${uni.admissionInfo.methods.map(method => `<li>${method}</li>`).join('')}
                                    </ul>
                                </div>
                                
                                ${uni.admissionInfo.examSubjects && uni.admissionInfo.examSubjects.length > 0 ? `
                                <div>
                                    <p class="text-sm font-semibold text-gray-800 mb-2">üìù T·ªï h·ª£p m√¥n x√©t tuy·ªÉn:</p>
                                    <div class="flex flex-wrap gap-2">
                                        ${uni.admissionInfo.examSubjects.slice(0, 6).map(subject => `
                                            <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">${subject}</span>
                                        `).join('')}
                                        ${uni.admissionInfo.examSubjects.length > 6 ? `<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">+${uni.admissionInfo.examSubjects.length - 6} t·ªï h·ª£p</span>` : ''}
                                    </div>
                                </div>
                                ` : ''}
                                
                                ${uni.admissionInfo.priority ? `
                                <div class="bg-yellow-50 p-3 rounded">
                                    <p class="text-sm"><span class="font-semibold text-gray-800">‚≠ê Th·ª© t·ª± ∆∞u ti√™n:</span> <span class="text-gray-700">${uni.admissionInfo.priority}</span></p>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }

                // Changes 2025 section
                let changesHtml = '';
                if (uni.changes2025) {
                    changesHtml = `
                        <div class="mt-6 pt-6 border-t border-gray-200">
                            <h3 class="text-lg font-bold text-gray-900 mb-3 flex items-center gap-2">
                                <i class="fas fa-star text-yellow-500"></i>
                                Thay ƒë·ªïi nƒÉm 2025
                            </h3>
                            <p class="text-sm text-gray-700 leading-relaxed">${uni.changes2025}</p>
                        </div>
                    `;
                }

                modalContent.innerHTML = `
                    <div class="p-6 max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-900 mb-1">${uni.name}</h2>
                                <div class="flex gap-2">
                                    <span class="inline-block ${uni.type === 'C√¥ng l·∫≠p' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'} text-xs px-3 py-1 rounded-full font-semibold">${uni.type}</span>
                                    <span class="inline-block bg-gray-200 text-gray-800 text-xs px-3 py-1 rounded-full font-semibold">${uni.shortName}</span>
                                    ${uni.ranking ? `<span class="inline-block bg-yellow-100 text-yellow-800 text-xs px-3 py-1 rounded-full font-semibold">#${uni.ranking}</span>` : ''}
                                </div>
                            </div>
                            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        ${uni.description ? `<p class="text-gray-600 mb-4 text-sm leading-relaxed">${uni.description}</p>` : ''}
                        
                        ${statsHtml}
                        
                        <div class="space-y-3 mt-6">
                            <div class="flex gap-3">
                                <i class="fas fa-map-marker-alt text-gray-800 mt-1"></i>
                                <div>
                                    <p class="text-sm text-gray-600">ƒê·ªãa ch·ªâ</p>
                                    <p class="font-semibold text-gray-900">${uni.address}, ${uni.district}</p>
                                </div>
                            </div>
                            
                            <div class="flex gap-3">
                                <i class="fas fa-phone text-gray-800 mt-1"></i>
                                <div>
                                    <p class="text-sm text-gray-600">ƒêi·ªán tho·∫°i</p>
                                    <a href="tel:${uni.phone}" class="font-semibold text-gray-900 hover:text-gray-700">${uni.phone}</a>
                                </div>
                            </div>
                            
                            ${uni.email ? `
                            <div class="flex gap-3">
                                <i class="fas fa-envelope text-gray-800 mt-1"></i>
                                <div>
                                    <p class="text-sm text-gray-600">Email</p>
                                    <a href="mailto:${uni.email}" class="font-semibold text-gray-900 hover:text-gray-700">${uni.email}</a>
                                </div>
                            </div>
                            ` : ''}
                            
                            ${uni.website ? `
                            <div class="flex gap-3">
                                <i class="fas fa-globe text-gray-800 mt-1"></i>
                                <div>
                                    <p class="text-sm text-gray-600">Website</p>
                                    <a href="${uni.website}" target="_blank" class="font-semibold text-blue-600 hover:text-blue-700">${uni.website}</a>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        
                        ${uni.specialties && uni.specialties.length > 0 ? `
                        <div class="mt-6 pt-6 border-t border-gray-200">
                            <p class="font-semibold text-gray-900 mb-3">üéØ Ng√†nh H·ªçc N·ªïi B·∫≠t</p>
                            <div class="flex flex-wrap gap-2">
                                ${uni.specialties.map(spec => `<span class="bg-gray-100 text-gray-700 px-3 py-1 rounded text-sm">${spec}</span>`).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${programsHtml}
                        ${scoresHtml}
                        ${admissionHtml}
                        ${changesHtml}
                        
                        <div class="mt-6 pt-6 border-t border-gray-200 flex gap-3">
                            <button 
                                onclick="closeModal()"
                                class="flex-1 px-4 py-3 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition font-semibold"
                            >
                                ƒê√≥ng
                            </button>
                            <button 
                                onclick="findNearbyRooms('${uni._id}'); closeModal();"
                                class="flex-1 px-4 py-3 bg-gray-800 text-white rounded hover:bg-gray-700 transition font-semibold"
                            >
                                <i class="fas fa-home mr-1"></i>T√¨m Ph√≤ng G·∫ßn Tr∆∞·ªùng
                            </button>
                        </div>
                    </div>
                `;
                
                document.getElementById('detailModal').classList.remove('hidden');
            } catch (error) {
                console.error('L·ªói:', error);
            }
        }

        // Close modal
        function closeModal() {
            document.getElementById('detailModal').classList.add('hidden');
        }

        // Find nearby rooms
        let nearbyRoomsMap = null;
        let allProperties = [];
        let currentUniversityId = null;
        let universityMarker = null; // L∆∞u reference c·ªßa marker tr∆∞·ªùng
        
        async function findNearbyRooms(universityId) {
            // T√¨m th√¥ng tin tr∆∞·ªùng
            const university = allUniversities.find(u => u._id === universityId);
            if (!university || !university.location || !university.location.coordinates) {
                showToast('Kh√¥ng t√¨m th·∫•y t·ªça ƒë·ªô tr∆∞·ªùng h·ªçc', 'error');
                return;
            }
            
            currentUniversityId = universityId;
            
            // M·ªü modal
            const modal = document.getElementById('nearbyRoomsModal');
            const loading = document.getElementById('nearbyRoomsLoading');
            const error = document.getElementById('nearbyRoomsError');
            const mapContainer = document.getElementById('nearbyRoomsMapContainer');
            
            modal.classList.remove('hidden');
            loading.classList.remove('hidden');
            error.classList.add('hidden');
            mapContainer.classList.add('hidden');
            
            // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ
            document.getElementById('nearbyModalTitle').textContent = `Ph√≤ng tr·ªç g·∫ßn ${university.name}`;
            document.getElementById('universityNameText').textContent = university.name;
            
            try {
                // L·∫•y danh s√°ch properties (limit=1000 ƒë·ªÉ l·∫•y nhi·ªÅu ph√≤ng h∆°n)
                const response = await fetch('/api/properties?limit=1000&status=available');
                if (!response.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i danh s√°ch ph√≤ng');
                
                const result = await response.json();
                
                // API tr·∫£ v·ªÅ { success, count, data, pagination }
                allProperties = result.data || [];
                
                if (!Array.isArray(allProperties)) {
                    throw new Error('D·ªØ li·ªáu ph√≤ng kh√¥ng h·ª£p l·ªá');
                }
                
                // Hi·ªÉn th·ªã b·∫£n ƒë·ªì
                loading.classList.add('hidden');
                mapContainer.classList.remove('hidden');
                
                // Kh·ªüi t·∫°o b·∫£n ƒë·ªì
                initNearbyRoomsMap(university);
                
                // L·ªçc v√† hi·ªÉn th·ªã ph√≤ng
                filterAndDisplayNearbyRooms();
                
            } catch (err) {
                console.error('L·ªói:', err);
                loading.classList.add('hidden');
                error.classList.remove('hidden');
                document.getElementById('nearbyRoomsErrorMessage').textContent = err.message;
            }
        }
        
        function initNearbyRoomsMap(university) {
            const mapElement = document.getElementById('nearbyRoomsMap');
            
            // X√≥a map c≈© n·∫øu c√≥
            if (nearbyRoomsMap) {
                nearbyRoomsMap.remove();
            }
            
            // T·∫°o map m·ªõi
            const [lng, lat] = university.location.coordinates;
            nearbyRoomsMap = L.map('nearbyRoomsMap').setView([lat, lng], 14);
            
            // Th√™m tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(nearbyRoomsMap);
            
            // Th√™m marker cho tr∆∞·ªùng
            const universityIcon = L.divIcon({
                html: '<div class="university-marker"><i class="fas fa-university"></i></div>',
                className: 'custom-div-icon',
                iconSize: [100, 100],
                iconAnchor: [50, 50],
                popupAnchor: [0, -50]
            });
            
            universityMarker = L.marker([lat, lng], { icon: universityIcon })
                .bindPopup(`
                    <div class="text-center p-2">
                        <div class="text-lg font-bold text-red-600 mb-1">üè´ ${university.name}</div>
                        <div class="text-sm text-gray-600">${university.address}</div>
                    </div>
                `)
                .addTo(nearbyRoomsMap)
                .openPopup();
        }
        
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // B√°n k√≠nh Tr√°i ƒê·∫•t (km)
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        function filterAndDisplayNearbyRooms() {
            const university = allUniversities.find(u => u._id === currentUniversityId);
            if (!university) return;
            
            const radius = parseFloat(document.getElementById('nearbyRoomsRadius').value);
            const [uniLng, uniLat] = university.location.coordinates;
            
            // L·ªçc properties trong b√°n k√≠nh
            const nearbyProperties = allProperties
                .filter(prop => {
                    if (!prop.location || !prop.location.coordinates) return false;
                    if (prop.status !== 'available') return false;
                    
                    const [propLng, propLat] = prop.location.coordinates;
                    const distance = calculateDistance(uniLat, uniLng, propLat, propLng);
                    prop.distance = distance;
                    return distance <= radius;
                })
                .sort((a, b) => a.distance - b.distance);
            
            // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng
            document.getElementById('nearbyRoomsCount').textContent = nearbyProperties.length;
            
            // X√≥a markers c≈© (tr·ª´ marker tr∆∞·ªùng v√† tile layer)
            nearbyRoomsMap.eachLayer(layer => {
                if (layer instanceof L.Marker && layer !== universityMarker) {
                    nearbyRoomsMap.removeLayer(layer);
                }
            });
            
            // Th√™m markers cho properties
            nearbyProperties.forEach((prop, index) => {
                const [propLng, propLat] = prop.location.coordinates;
                
                const propertyIcon = L.divIcon({
                    html: `<div class="property-location-marker">
                        <i class="fas fa-map-marker-alt"></i>
                    </div>`,
                    className: 'custom-div-icon',
                    iconSize: [50, 65],
                    iconAnchor: [25, 65],
                    popupAnchor: [0, -65]
                });
                
                // L·∫•y ƒë·ªãa ch·ªâ ƒë·∫ßy ƒë·ªß
                const fullAddress = prop.address?.full || prop.address?.street || 
                                   (typeof prop.address === 'string' ? prop.address : 'Ch∆∞a c√≥ ƒë·ªãa ch·ªâ');
                
                const marker = L.marker([propLat, propLng], { icon: propertyIcon })
                    .bindPopup(`
                        <div class="property-popup">
                            <h4 class="font-bold mb-2 text-blue-600">${prop.title}</h4>
                            <div class="space-y-1">
                                <p class="text-sm text-gray-600">
                                    <i class="fas fa-map-marker-alt text-red-500 mr-1"></i>
                                    ${fullAddress}
                                </p>
                                <p class="text-sm font-semibold text-gray-800">
                                    <i class="fas fa-dollar-sign text-green-500 mr-1"></i>
                                    ${prop.price.toLocaleString('vi-VN')} VNƒê/th√°ng
                                </p>
                                <p class="text-sm text-gray-600">
                                    <i class="fas fa-ruler-combined text-blue-500 mr-1"></i>
                                    C√°ch tr∆∞·ªùng: <strong>${prop.distance.toFixed(2)} km</strong>
                                </p>
                                <a href="/property/${prop._id}" 
                                   class="inline-block mt-2 px-4 py-2 bg-blue-600 text-white text-sm font-semibold rounded-lg hover:bg-blue-700 transition w-full text-center">
                                    <i class="fas fa-eye mr-1"></i>Xem chi ti·∫øt
                                </a>
                            </div>
                        </div>
                    `)
                    .addTo(nearbyRoomsMap);
            });
            
            // Hi·ªÉn th·ªã danh s√°ch
            displayNearbyRoomsList(nearbyProperties);
        }
        
        function displayNearbyRoomsList(properties) {
            const listContainer = document.getElementById('nearbyRoomsPropertyList');
            
            if (properties.length === 0) {
                listContainer.innerHTML = '<p class="text-center text-gray-500 py-4">Kh√¥ng t√¨m th·∫•y ph√≤ng tr·ªç trong b√°n k√≠nh n√†y.</p>';
                return;
            }
            
            listContainer.innerHTML = properties.map(prop => {
                const imageUrl = prop.images && prop.images.length > 0 ? prop.images[0] : 'https://via.placeholder.com/80x80?text=No+Image';
                const fullAddress = prop.address?.full || prop.address?.street || 
                                   (typeof prop.address === 'string' ? prop.address : 'Ch∆∞a c√≥ ƒë·ªãa ch·ªâ');
                return `
                <div class="flex gap-3 p-3 border border-gray-200 rounded-lg hover:shadow-md transition cursor-pointer" onclick="window.location.href='/property/${prop._id}'">
                    <img src="${imageUrl}" alt="${prop.title}" class="w-20 h-20 object-cover rounded" onerror="this.src='https://via.placeholder.com/80x80?text=No+Image'">
                    <div class="flex-1 min-w-0">
                        <h5 class="font-semibold text-gray-800 truncate">${prop.title}</h5>
                        <p class="text-sm text-gray-600 truncate">${fullAddress}</p>
                        <div class="flex items-center justify-between mt-1">
                            <span class="text-sm font-semibold text-gray-800">${prop.price.toLocaleString('vi-VN')} VNƒê/th√°ng</span>
                            <span class="text-xs text-gray-500"><i class="fas fa-map-marker-alt mr-1"></i>${prop.distance.toFixed(2)} km</span>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }
        
        // ƒê√≥ng modal
        document.getElementById('closeNearbyRoomsModal')?.addEventListener('click', () => {
            document.getElementById('nearbyRoomsModal').classList.add('hidden');
        });
        
        document.getElementById('nearbyRoomsBackdrop')?.addEventListener('click', () => {
            document.getElementById('nearbyRoomsModal').classList.add('hidden');
        });
        
        // Thay ƒë·ªïi b√°n k√≠nh
        document.getElementById('nearbyRoomsRadius')?.addEventListener('change', () => {
            if (currentUniversityId) {
                filterAndDisplayNearbyRooms();
            }
        });
        
        // Retry
        document.getElementById('retryNearbyRooms')?.addEventListener('click', () => {
            if (currentUniversityId) {
                findNearbyRooms(currentUniversityId);
            }
        });

        // Update pagination
        function updatePagination() {
            const totalPages = Math.ceil(filteredUniversities.length / ITEMS_PER_PAGE);
            const container = document.getElementById('paginationContainer');

            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = '';

            // Previous
            html += `<button onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''} class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition">‚Üê Tr∆∞·ªõc</button>`;

            // Numbers
            const maxPages = 5;
            let start = Math.max(1, currentPage - Math.floor(maxPages / 2));
            let end = Math.min(totalPages, start + maxPages - 1);
            if (end - start < maxPages - 1) start = Math.max(1, end - maxPages + 1);

            if (start > 1) {
                html += `<button onclick="goToPage(1)" class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-100 transition">1</button>`;
                if (start > 2) html += `<span class="px-3 py-2">...</span>`;
            }

            for (let i = start; i <= end; i++) {
                html += `<button onclick="goToPage(${i})" class="px-4 py-2 border ${i === currentPage ? 'bg-gray-800 text-white border-gray-800' : 'border-gray-300 hover:bg-gray-100'} rounded transition">${i}</button>`;
            }

            if (end < totalPages) {
                if (end < totalPages - 1) html += `<span class="px-3 py-2">...</span>`;
                html += `<button onclick="goToPage(${totalPages})" class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-100 transition">${totalPages}</button>`;
            }

            // Next
            html += `<button onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''} class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition">Ti·∫øp ‚Üí</button>`;

            container.innerHTML = html;
        }

        // Go to page
        function goToPage(page) {
            const totalPages = Math.ceil(filteredUniversities.length / ITEMS_PER_PAGE);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                displayUniversities();
                updatePagination();
                window.scrollTo(0, 300);
            }
        }

        // Close modal on background click
        document.getElementById('detailModal')?.addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });
    </script>
</body>
</html>
