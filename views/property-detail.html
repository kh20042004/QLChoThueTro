<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi tiết phòng - HomeRent</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        html { scroll-behavior: smooth; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #F3F4F6;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #9CA3AF;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #6B7280;
        }

        /* Animation slideDown for dropdown */
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .animate-slideDown {
            animation: slideDown 0.3s ease-out;
        }

        /* Animation fadeIn */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out;
        }

        /* Animation fadeInUp */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .animate-fadeInUp {
            animation: fadeInUp 0.4s ease-out;
        }

        .property-gallery img {
            cursor: pointer;
            transition: transform 0.3s;
        }

        .property-gallery img:hover {
            transform: scale(1.05);
        }

        #map {
            height: 400px;
            border-radius: 12px;
        }

        /* Button Save/Favorite Styling */
        #saveBtn {
            text-transform: none !important;
            font-size: inherit !important;
            letter-spacing: normal !important;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Radial Gradient Background - Fixed Full Page -->
    <div class="fixed inset-0 w-full h-full z-0" style="background: radial-gradient(125% 125% at 50% 10%, #fff 40%, #1d2125 100%);"></div>
    
    <!-- Content Wrapper -->
    <div class="relative z-10">
        <!-- Header -->
        <header class="sticky top-0 z-50 bg-white/80 backdrop-blur-md shadow-sm">
            <nav class="container mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <!-- Logo -->
                    <a href="/" class="flex items-center space-x-2 group">
                        <i class="fas fa-home text-2xl text-gray-600 group-hover:text-gray-800 transition-colors duration-300"></i>
                        <span class="text-xl font-bold text-gray-800">HomeRent</span>
                    </a>
                    
                    <!-- Desktop Menu -->
                    <div class="hidden md:flex items-center space-x-8">
                        <a href="/" class="text-gray-700 hover:text-gray-900 transition-colors duration-300 relative group">
                            Trang chủ
                            <span class="absolute bottom-0 left-0 w-0 h-0.5 bg-gray-800 group-hover:w-full transition-all duration-300"></span>
                        </a>
                        <a href="/properties" class="text-gray-700 hover:text-gray-900 transition-colors duration-300 relative group">
                            Tìm phòng
                            <span class="absolute bottom-0 left-0 w-0 h-0.5 bg-gray-800 group-hover:w-full transition-all duration-300"></span>
                        </a>
                        <a href="/universities" class="text-gray-700 hover:text-gray-900 transition-colors duration-300 relative group">
                            Trường ĐH
                            <span class="absolute bottom-0 left-0 w-0 h-0.5 bg-gray-800 group-hover:w-full transition-all duration-300"></span>
                        </a>
                        <a href="/about" class="text-gray-700 hover:text-gray-900 transition-colors duration-300 relative group">
                            Giới thiệu
                            <span class="absolute bottom-0 left-0 w-0 h-0.5 bg-gray-800 group-hover:w-full transition-all duration-300"></span>
                        </a>
                        <a href="/contact" class="text-gray-700 hover:text-gray-900 transition-colors duration-300 relative group">
                            Liên hệ
                            <span class="absolute bottom-0 left-0 w-0 h-0.5 bg-gray-800 group-hover:w-full transition-all duration-300"></span>
                        </a>
                    </div>
                    
                    <!-- Auth Buttons (Guest) -->
                    <div class="hidden md:flex items-center space-x-3" id="navbarGuest">
                        <a href="/auth/login" class="px-4 py-2 text-gray-700 hover:text-gray-900 transition-colors duration-300">
                            <i class="fas fa-sign-in-alt mr-1"></i>Đăng nhập
                        </a>
                        <a href="/auth/register" class="px-5 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition-all duration-300 shadow-sm hover:shadow-md">
                            <i class="fas fa-user-plus mr-1"></i>Đăng ký
                        </a>
                    </div>
                    
                    <!-- User Menu (Logged in) -->
                    <div class="hidden md:flex items-center space-x-4" id="navbarUser" style="display: none;">
                        <!-- Notifications -->
                        <a href="/notifications" class="relative p-2 text-gray-600 hover:text-gray-900 transition-colors duration-300">
                            <i class="fas fa-bell text-xl"></i>
                            <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs w-5 h-5 flex items-center justify-center rounded-full">3</span>
                        </a>
                        
                        <!-- Favorites -->
                        <a href="/favorites" class="relative p-2 text-gray-600 hover:text-gray-900 transition-colors duration-300">
                            <i class="fas fa-heart text-xl"></i>
                            <span id="favoriteBadge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs w-5 h-5 flex items-center justify-center rounded-full">0</span>
                        </a>
                        
                        <!-- Chat/Messages -->
                        <button onclick="window.location.href='/chat'" class="relative p-2 text-gray-600 hover:text-gray-900 transition-colors duration-300" title="Tin nhắn">
                            <i class="fas fa-comments text-xl"></i>
                            <span id="chatBadge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs w-5 h-5 flex items-center justify-center rounded-full">0</span>
                        </button>
                        
                        <!-- Post Property -->
                        <a href="/property/create" class="px-5 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition-all duration-300 shadow-sm hover:shadow-md">
                            <i class="fas fa-plus mr-1"></i>Đăng tin
                        </a>
                        
                        <!-- Admin Panel Button (Only for admin) -->
                        <a href="/admin/dashboard" id="adminPanelBtn" style="display: none;" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg hover:from-purple-700 hover:to-pink-700 transition-all duration-300 shadow-sm hover:shadow-md">
                            <i class="fas fa-crown mr-1"></i>Admin
                        </a>
                        
                        <!-- User Dropdown -->
                        <div class="relative group">
                            <button class="flex items-center space-x-2">
                                <img src="https://via.placeholder.com/40/6B7280/ffffff?text=U" alt="Avatar" class="w-8 h-8 rounded-full border-2 border-gray-300" id="userAvatar">
                                <span class="text-gray-700" id="userName">Người dùng</span>
                                <i class="fas fa-chevron-down text-xs text-gray-500"></i>
                            </button>
                            
                            <div class="absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-lg border border-gray-100 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 animate-slideDown">
                                <div class="p-3 border-b border-gray-100">
                                    <p class="text-sm text-gray-500" id="userEmail">user@example.com</p>
                                </div>
                                <a href="/profile" class="block px-4 py-2 text-gray-700 hover:bg-gray-50 transition-colors duration-200">
                                    <i class="fas fa-user mr-2 text-gray-500"></i>Hồ sơ cá nhân
                                </a>
                                <a href="/bookings" class="block px-4 py-2 text-gray-700 hover:bg-gray-50 transition-colors duration-200">
                                    <i class="fas fa-calendar mr-2 text-gray-500"></i>Đơn đặt phòng
                                </a>
                                <a href="/my-properties" class="block px-4 py-2 text-gray-700 hover:bg-gray-50 transition-colors duration-200">
                                    <i class="fas fa-home mr-2 text-gray-500"></i>Nhà/phòng của tôi
                                </a>
                                <a href="/settings" class="block px-4 py-2 text-gray-700 hover:bg-gray-50 transition-colors duration-200">
                                    <i class="fas fa-cog mr-2 text-gray-500"></i>Cài đặt
                                </a>
                                <div class="border-t border-gray-100"></div>
                                <a href="/logout" onclick="handleLogout(event)" class="block px-4 py-2 text-red-600 hover:bg-gray-50 transition-colors duration-200">
                                    <i class="fas fa-sign-out-alt mr-2"></i>Đăng xuất
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mobile Menu Button -->
                    <button class="md:hidden text-gray-700" id="mobileMenuBtn">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
                
                <!-- Mobile Menu -->
                <div class="hidden md:hidden mt-4 pb-4 border-t border-gray-100" id="mobileMenu">
                    <div class="flex flex-col space-y-3 mt-4">
                        <a href="/" class="text-gray-700 hover:text-gray-900 py-2">Trang chủ</a>
                        <a href="/properties" class="text-gray-700 hover:text-gray-900 py-2">Tìm phòng</a>
                        <a href="/universities" class="text-gray-700 hover:text-gray-900 py-2">Trường ĐH</a>
                        <a href="/about" class="text-gray-700 hover:text-gray-900 py-2">Giới thiệu</a>
                        <a href="/contact" class="text-gray-700 hover:text-gray-900 py-2">Liên hệ</a>
                        <a href="/auth/login" class="text-gray-700 hover:text-gray-900 py-2" id="mobileLoginBtn">Đăng nhập</a>
                        <a href="/auth/register" class="text-gray-700 hover:text-gray-900 py-2" id="mobileRegisterBtn">Đăng ký</a>
                    </div>
                </div>
            </nav>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-8">
        <!-- Breadcrumb -->
        <nav class="mb-6">
            <ol class="flex items-center space-x-2 text-sm text-gray-600">
                <li><a href="/" class="hover:text-gray-900">Trang chủ</a></li>
                <li><i class="fas fa-chevron-right text-xs"></i></li>
                <li><a href="/properties" class="hover:text-gray-900">Nhà/Phòng</a></li>
                <li><i class="fas fa-chevron-right text-xs"></i></li>
                <li class="text-gray-900 font-medium" id="breadcrumb-title">Chi tiết</li>
            </ol>
        </nav>

        <!-- Loading State -->
        <div id="loading" class="flex justify-center items-center py-20">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900 mx-auto mb-4"></div>
                <p class="text-gray-600">Đang tải thông tin...</p>
            </div>
        </div>

        <!-- Property Detail -->
        <div id="property-detail" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Left Column -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Image Gallery -->
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <div id="main-image" class="h-96 bg-gray-200"></div>
                        <div id="thumbnail-gallery" class="grid grid-cols-4 gap-2 p-4"></div>
                    </div>

                    <!-- Property Info -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex items-start justify-between mb-4">
                            <div>
                                <span id="property-type" class="inline-block px-3 py-1 bg-gray-100 text-gray-700 text-sm rounded-full mb-2"></span>
                                <h1 id="property-title" class="text-3xl font-bold text-gray-900 mb-2"></h1>
                                <p id="property-address" class="text-gray-600">
                                    <i class="fas fa-map-marker-alt mr-2"></i>
                                </p>
                            </div>
                            <div class="text-right">
                                <div id="property-price" class="text-3xl font-bold text-gray-900"></div>
                                <div class="text-sm text-gray-500">/ tháng</div>
                            </div>
                        </div>

                        <!-- Stats -->
                        <div class="grid grid-cols-3 gap-4 py-4 border-t border-b border-gray-200">
                            <div class="text-center">
                                <i class="fas fa-expand-arrows-alt text-gray-400 mb-1"></i>
                                <div id="property-area" class="font-semibold text-gray-900"></div>
                                <div class="text-sm text-gray-500">Diện tích</div>
                            </div>
                            <div class="text-center">
                                <i class="fas fa-bed text-gray-400 mb-1"></i>
                                <div id="property-bedrooms" class="font-semibold text-gray-900"></div>
                                <div class="text-sm text-gray-500">Phòng ngủ</div>
                            </div>
                            <div class="text-center">
                                <i class="fas fa-bath text-gray-400 mb-1"></i>
                                <div id="property-bathrooms" class="font-semibold text-gray-900"></div>
                                <div class="text-sm text-gray-500">Phòng tắm</div>
                            </div>
                        </div>

                        <!-- Description -->
                        <div class="mt-6">
                            <h2 class="text-xl font-bold text-gray-900 mb-3">Mô tả</h2>
                            <div id="property-description" class="text-gray-700 leading-relaxed"></div>
                        </div>

                        <!-- Amenities -->
                        <div class="mt-6">
                            <h2 class="text-xl font-bold text-gray-900 mb-3">Tiện nghi</h2>
                            <div id="property-amenities" class="grid grid-cols-2 md:grid-cols-3 gap-3"></div>
                        </div>
                    </div>

                    <!-- Map -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h2 class="text-xl font-bold text-gray-900 mb-4">
                            <i class="fas fa-map-marker-alt text-blue-500 mr-2"></i>
                            Vị trí trên bản đồ
                        </h2>
                        <div id="map"></div>
                        <p class="text-sm text-gray-600 mt-3">
                            <i class="fas fa-info-circle mr-2"></i>
                            Click và kéo để di chuyển bản đồ. Cuộn chuột để zoom in/out.
                        </p>
                    </div>

                    <!-- Reviews Section -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-xl font-bold text-gray-900">
                                <i class="fas fa-star text-yellow-500 mr-2"></i>
                                Đánh giá
                            </h2>
                            <button onclick="openReviewModal()" class="px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg hover:from-blue-600 hover:to-blue-700 transition-all font-semibold shadow-sm hover:shadow-md">
                                <i class="fas fa-edit mr-2"></i>Viết đánh giá
                            </button>
                        </div>

                        <!-- Rating Summary -->
                        <div id="ratingSummary" class="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg p-4 mb-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="flex items-center mb-2">
                                        <span id="averageRating" class="text-4xl font-bold text-gray-900 mr-2">0.0</span>
                                        <div>
                                            <div id="averageStars" class="flex text-yellow-500 text-xl mb-1"></div>
                                            <p id="totalReviews" class="text-sm text-gray-600">0 đánh giá</p>
                                        </div>
                                    </div>
                                </div>
                                <div id="ratingBars" class="space-y-1 w-48"></div>
                            </div>
                        </div>

                        <!-- Reviews List -->
                        <div id="reviewsList" class="space-y-4">
                            <!-- Reviews will be loaded here -->
                            <div class="text-center py-8 text-gray-500">
                                <i class="fas fa-comments text-4xl mb-3 opacity-50"></i>
                                <p>Chưa có đánh giá nào</p>
                            </div>
                        </div>

                        <!-- Load More Button -->
                        <div id="loadMoreReviews" class="text-center mt-6 hidden">
                            <button onclick="loadMoreReviews()" class="px-6 py-2 text-blue-600 hover:text-blue-700 font-semibold">
                                <i class="fas fa-chevron-down mr-2"></i>Xem thêm đánh giá
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Right Column - Sidebar -->
                <div class="space-y-6">
                    <!-- Contact Card -->
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl shadow-lg border-2 border-blue-100 p-6 sticky top-4">
                        <h3 class="text-xl font-bold text-gray-900 mb-5 flex items-center">
                            <i class="fas fa-address-card text-blue-600 mr-2"></i>
                            Thông tin liên hệ
                        </h3>
                        
                        <div id="landlord-info" class="mb-6">
                            <div class="flex items-center space-x-3 mb-5 p-3 bg-white rounded-lg shadow-sm">
                                <img id="landlord-avatar" src="" alt="Landlord" class="w-14 h-14 rounded-full object-cover border-3 border-blue-200 shadow">
                                <div>
                                    <div id="landlord-name" class="font-bold text-gray-900 text-lg"></div>
                                    <div class="text-sm text-blue-600 font-medium">
                                        <i class="fas fa-user-tie mr-1"></i>Chủ nhà
                                    </div>
                                </div>
                            </div>
                            <div id="landlord-phone" class="flex items-center text-gray-800 mb-3 p-3 bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow">
                                <i class="fas fa-phone mr-3 text-green-500 text-lg"></i>
                                <span class="font-semibold"></span>
                            </div>
                            <div id="landlord-email" class="flex items-center text-gray-800 p-3 bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow">
                                <i class="fas fa-envelope mr-3 text-blue-500 text-lg"></i>
                                <span class="font-semibold text-sm break-all"></span>
                            </div>
                        </div>

                        <button id="callBtn" onclick="handleCall()" class="w-full bg-gradient-to-r from-gray-800 to-gray-900 text-white py-3.5 rounded-lg hover:from-gray-900 hover:to-black transition-all duration-300 mb-3 font-semibold shadow-md hover:shadow-lg transform hover:scale-105">
                            <i class="fas fa-phone mr-2"></i>Gọi điện
                        </button>
                        <button id="bookingBtn" onclick="openBookingModal()" class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white py-3.5 rounded-lg hover:from-green-600 hover:to-green-700 transition-all duration-300 mb-3 font-semibold shadow-md hover:shadow-lg transform hover:scale-105">
                            <i class="fas fa-calendar-check mr-2"></i>Đặt lịch xem phòng
                        </button>
                        <button id="messageBtn" onclick="handleMessage()" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white py-3.5 rounded-lg hover:from-blue-600 hover:to-blue-700 transition-all duration-300 mb-3 font-semibold shadow-md hover:shadow-lg transform hover:scale-105">
                            <i class="fas fa-envelope mr-2"></i>Gửi tin nhắn
                        </button>
                        <button id="saveBtn" onclick="handleSaveProperty(event)" 
                                class="w-full py-3.5 rounded-lg transition-all duration-300 mb-3 favorite-btn font-semibold shadow-md hover:shadow-lg transform hover:scale-105 bg-gradient-to-r from-pink-100 to-red-100 text-red-600 hover:from-pink-200 hover:to-red-200 border-2 border-red-200"
                                data-favorite-property=""
                                style="text-transform: none;" 
                                title="Thêm yêu thích">
                            <i class="far fa-heart mr-2"></i> Lưu tin
                        </button>
                    </div>

                    <!-- Report Card -->
                    <div class="bg-gradient-to-br from-yellow-50 to-orange-50 border-2 border-yellow-300 rounded-xl p-5 shadow-md hover:shadow-lg transition-shadow">
                        <h4 class="font-bold text-gray-900 mb-3 flex items-center text-base">
                            <i class="fas fa-exclamation-triangle text-yellow-600 mr-2 text-xl"></i>
                            Báo cáo tin đăng
                        </h4>
                        <p class="text-sm text-gray-700 mb-4 font-medium">Nếu bạn thấy tin đăng này có vấn đề, vui lòng báo cáo cho chúng tôi.</p>
                        <button onclick="openReportModal()" class="w-full bg-gradient-to-r from-yellow-400 to-orange-400 text-gray-900 font-bold py-2.5 px-4 rounded-lg hover:from-yellow-500 hover:to-orange-500 transition-all duration-300 shadow-sm hover:shadow-md transform hover:scale-105">
                            <i class="fas fa-flag mr-2"></i>Báo cáo ngay
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error State -->
        <div id="error" class="hidden text-center py-20">
            <i class="fas fa-exclamation-circle text-6xl text-red-500 mb-4"></i>
            <h2 class="text-2xl font-bold text-gray-900 mb-2">Không tìm thấy bất động sản</h2>
            <p class="text-gray-600 mb-6">Bất động sản này không tồn tại hoặc đã bị xóa.</p>
            <a href="/" class="inline-block px-6 py-3 bg-gray-900 text-white rounded-lg hover:bg-gray-800">
                Về trang chủ
            </a>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-900/95 backdrop-blur-sm pt-12 pb-6 text-gray-300">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8 mb-8">
                <div>
                    <h5 class="font-bold text-white mb-4 flex items-center">
                        <i class="fas fa-home mr-2"></i>HomeRent
                    </h5>
                    <p class="text-gray-400 mb-4">
                        Hệ thống cho thuê nhà/phòng trọ thông minh với công nghệ AI, giúp bạn tìm kiếm và quản lý bất động sản dễ dàng.
                    </p>
                    <div class="flex space-x-3">
                        <a href="#" class="text-gray-400 hover:text-white transition-colors duration-300">
                            <i class="fab fa-facebook text-xl"></i>
                        </a>
                        <a href="#" class="text-gray-400 hover:text-white transition-colors duration-300">
                            <i class="fab fa-twitter text-xl"></i>
                        </a>
                        <a href="#" class="text-gray-400 hover:text-white transition-colors duration-300">
                            <i class="fab fa-instagram text-xl"></i>
                        </a>
                        <a href="#" class="text-gray-400 hover:text-white transition-colors duration-300">
                            <i class="fab fa-youtube text-xl"></i>
                        </a>
                    </div>
                </div>
                
                <div>
                    <h6 class="font-semibold text-white mb-4">Liên Kết</h6>
                    <ul class="space-y-2">
                        <li><a href="/" class="text-gray-400 hover:text-white transition-colors duration-300">Trang chủ</a></li>
                        <li><a href="/properties" class="text-gray-400 hover:text-white transition-colors duration-300">Tìm phòng</a></li>
                        <li><a href="/about" class="text-gray-400 hover:text-white transition-colors duration-300">Giới thiệu</a></li>
                        <li><a href="/contact" class="text-gray-400 hover:text-white transition-colors duration-300">Liên hệ</a></li>
                    </ul>
                </div>
                
                <div>
                    <h6 class="font-semibold text-white mb-4">Hỗ Trợ</h6>
                    <ul class="space-y-2">
                        <li><a href="/faq" class="text-gray-400 hover:text-white transition-colors duration-300">Câu hỏi thường gặp</a></li>
                        <li><a href="/terms" class="text-gray-400 hover:text-white transition-colors duration-300">Điều khoản</a></li>
                        <li><a href="/privacy" class="text-gray-400 hover:text-white transition-colors duration-300">Bảo mật</a></li>
                        <li><a href="/guide" class="text-gray-400 hover:text-white transition-colors duration-300">Hướng dẫn</a></li>
                    </ul>
                </div>
                
                <div>
                    <h6 class="font-semibold text-white mb-4">Liên Hệ</h6>
                    <ul class="space-y-2 text-gray-400">
                        <li>
                            <i class="fas fa-map-marker-alt mr-2"></i>
                            123 Đường ABC, Quận 1, TP.HCM
                        </li>
                        <li>
                            <i class="fas fa-phone mr-2"></i>
                            <a href="tel:0123456789" class="hover:text-white transition-colors duration-300">0123 456 789</a>
                        </li>
                        <li>
                            <i class="fas fa-envelope mr-2"></i>
                            <a href="mailto:info@homerent.vn" class="hover:text-white transition-colors duration-300">info@homerent.vn</a>
                        </li>
                    </ul>
                </div>
            </div>
            
            <div class="border-t border-gray-700 pt-6 text-center text-gray-400">
                <p class="mb-1">
                    &copy; 2024 HomeRent. All rights reserved. Developed with 
                    <i class="fas fa-heart text-red-500"></i> by Your Team
                </p>
                <small>Phiên bản 1.0.0</small>
            </div>
        </div>
    </footer>
    </div>
    <!-- End Content Wrapper -->

    <!-- Booking Modal -->
    <div id="bookingModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto animate-fadeInUp">
            <div class="p-6">
                <!-- Header -->
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-bold text-gray-900">
                        <i class="fas fa-calendar-check text-green-600 mr-2"></i>
                        Đặt lịch xem phòng
                    </h3>
                    <button onclick="closeBookingModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>

                <!-- Form -->
                <form id="bookingForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-user mr-1"></i>Họ tên
                        </label>
                        <input type="text" id="bookingName" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                               placeholder="Nhập họ tên của bạn">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-phone mr-1"></i>Số điện thoại
                        </label>
                        <input type="tel" id="bookingPhone" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                               placeholder="Nhập số điện thoại">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-calendar mr-1"></i>Ngày xem phòng
                        </label>
                        <input type="date" id="bookingDate" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-clock mr-1"></i>Thời gian xem phòng
                        </label>
                        <select id="bookingTime" required 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            <option value="">Chọn thời gian</option>
                            <option value="08:00">08:00 - 09:00</option>
                            <option value="09:00">09:00 - 10:00</option>
                            <option value="10:00">10:00 - 11:00</option>
                            <option value="11:00">11:00 - 12:00</option>
                            <option value="14:00">14:00 - 15:00</option>
                            <option value="15:00">15:00 - 16:00</option>
                            <option value="16:00">16:00 - 17:00</option>
                            <option value="17:00">17:00 - 18:00</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-comment mr-1"></i>Ghi chú (tùy chọn)
                        </label>
                        <textarea id="bookingNote" rows="3"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                  placeholder="Nhập ghi chú nếu có..."></textarea>
                    </div>

                    <!-- Buttons -->
                    <div class="flex space-x-3 pt-4">
                        <button type="button" onclick="closeBookingModal()" 
                                class="flex-1 px-4 py-3 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors font-semibold">
                            Hủy
                        </button>
                        <button type="submit" 
                                class="flex-1 px-4 py-3 text-white bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 rounded-lg transition-all font-semibold shadow-lg hover:shadow-xl transform hover:scale-105">
                            <i class="fas fa-check mr-2"></i>Xác nhận
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div id="reportModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto animate-fadeInUp">
            <div class="p-6">
                <!-- Header -->
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-bold text-gray-900">
                        <i class="fas fa-flag text-yellow-600 mr-2"></i>
                        Báo cáo tin đăng
                    </h3>
                    <button onclick="closeReportModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>

                <!-- Form -->
                <form id="reportForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-exclamation-circle mr-1"></i>Lý do báo cáo
                        </label>
                        <select id="reportReason" required 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                            <option value="">Chọn lý do</option>
                            <option value="fake">Tin đăng giả mạo</option>
                            <option value="scam">Lừa đảo</option>
                            <option value="duplicate">Trùng lặp</option>
                            <option value="inappropriate">Nội dung không phù hợp</option>
                            <option value="wrong_info">Thông tin sai lệch</option>
                            <option value="spam">Spam</option>
                            <option value="other">Lý do khác</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-comment-alt mr-1"></i>Mô tả chi tiết
                        </label>
                        <textarea id="reportDescription" required rows="4"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                                  placeholder="Vui lòng mô tả chi tiết vấn đề..."></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-envelope mr-1"></i>Email liên hệ (tùy chọn)
                        </label>
                        <input type="email" id="reportEmail"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                               placeholder="Nhập email để nhận phản hồi">
                    </div>

                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <p class="text-sm text-gray-700">
                            <i class="fas fa-info-circle text-yellow-600 mr-2"></i>
                            Chúng tôi sẽ xem xét báo cáo của bạn trong vòng 24-48 giờ.
                        </p>
                    </div>

                    <!-- Buttons -->
                    <div class="flex space-x-3 pt-4">
                        <button type="button" onclick="closeReportModal()" 
                                class="flex-1 px-4 py-3 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors font-semibold">
                            Hủy
                        </button>
                        <button type="submit" 
                                class="flex-1 px-4 py-3 text-white bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 rounded-lg transition-all font-semibold shadow-lg hover:shadow-xl transform hover:scale-105">
                            <i class="fas fa-paper-plane mr-2"></i>Gửi báo cáo
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Review Modal -->
    <div id="reviewModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto animate-fadeInUp">
            <div class="p-6">
                <!-- Header -->
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-bold text-gray-900">
                        <i class="fas fa-star text-yellow-500 mr-2"></i>
                        Viết đánh giá
                    </h3>
                    <button onclick="closeReviewModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>

                <!-- Form -->
                <form id="reviewForm" class="space-y-4">
                    <!-- Rating Stars -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">
                            <i class="fas fa-star mr-1"></i>Đánh giá của bạn
                        </label>
                        <div class="flex items-center space-x-2">
                            <div id="reviewStars" class="flex text-3xl cursor-pointer">
                                <i class="far fa-star hover:text-yellow-500 transition-colors" data-rating="1"></i>
                                <i class="far fa-star hover:text-yellow-500 transition-colors" data-rating="2"></i>
                                <i class="far fa-star hover:text-yellow-500 transition-colors" data-rating="3"></i>
                                <i class="far fa-star hover:text-yellow-500 transition-colors" data-rating="4"></i>
                                <i class="far fa-star hover:text-yellow-500 transition-colors" data-rating="5"></i>
                            </div>
                            <span id="ratingText" class="text-sm font-semibold text-gray-600 ml-2">Chọn số sao</span>
                        </div>
                        <input type="hidden" id="reviewRating" name="rating" required>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-heading mr-1"></i>Tiêu đề
                        </label>
                        <input type="text" id="reviewTitle" required maxlength="100"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="Tóm tắt đánh giá của bạn">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-comment-dots mr-1"></i>Nhận xét chi tiết
                        </label>
                        <textarea id="reviewComment" required rows="5"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                  placeholder="Chia sẻ trải nghiệm của bạn về phòng này..."></textarea>
                        <p class="text-xs text-gray-500 mt-1">
                            <i class="fas fa-info-circle mr-1"></i>
                            Vui lòng viết đánh giá khách quan và trung thực
                        </p>
                    </div>

                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <p class="text-sm text-gray-700 flex items-start">
                            <i class="fas fa-shield-alt text-blue-600 mr-2 mt-1"></i>
                            <span>Đánh giá của bạn sẽ được hiển thị công khai và giúp người khác đưa ra quyết định tốt hơn.</span>
                        </p>
                    </div>

                    <!-- Buttons -->
                    <div class="flex space-x-3 pt-4">
                        <button type="button" onclick="closeReviewModal()" 
                                class="flex-1 px-4 py-3 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors font-semibold">
                            Hủy
                        </button>
                        <button type="submit" 
                                class="flex-1 px-4 py-3 text-white bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 rounded-lg transition-all font-semibold shadow-lg hover:shadow-xl transform hover:scale-105">
                            <i class="fas fa-paper-plane mr-2"></i>Gửi đánh giá
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""></script>
    <script src="/js/auth.js"></script>
    <script src="/js/favorites.js"></script>
    
    <script>
        // Get property ID from URL
        const propertyId = window.location.pathname.split('/').pop();
        
        // Store landlord info globally
        let landlordPhone = '';
        let landlordId = '';
        let currentPropertyId = '';

        // Load property data
        async function loadPropertyDetail() {
            try {
                const response = await fetch(`/api/properties/${propertyId}`);
                
                if (!response.ok) {
                    throw new Error('Property not found');
                }

                const result = await response.json();
                const property = result.data;

                // Hide loading, show content
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('property-detail').classList.remove('hidden');

                // Populate data
                populatePropertyData(property);
                initializeMap(property);
                
            } catch (error) {
                console.error('Error loading property:', error);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('error').classList.remove('hidden');
            }
        }

        function populatePropertyData(property) {
            // Title and basic info
            document.getElementById('breadcrumb-title').textContent = property.title;
            document.getElementById('property-title').textContent = property.title;
            document.getElementById('property-type').textContent = getPropertyTypeLabel(property.propertyType);
            
            // Address
            document.getElementById('property-address').innerHTML = `
                <i class="fas fa-map-marker-alt mr-2"></i>
                ${property.address.street}, ${property.address.ward}, ${property.address.district}, ${property.address.city}
            `;

            // Price
            const price = (property.price / 1000000).toFixed(1);
            document.getElementById('property-price').textContent = price + ' triệu';

            // Stats
            document.getElementById('property-area').textContent = property.area + 'm²';
            document.getElementById('property-bedrooms').textContent = property.bedrooms || 0;
            document.getElementById('property-bathrooms').textContent = property.bathrooms || 0;

            // Description
            document.getElementById('property-description').textContent = property.description;

            // Images
            if (property.images && property.images.length > 0) {
                const mainImage = document.getElementById('main-image');
                mainImage.innerHTML = `<img src="${property.images[0]}" alt="${property.title}" class="w-full h-full object-cover">`;
                
                const thumbnailGallery = document.getElementById('thumbnail-gallery');
                thumbnailGallery.innerHTML = property.images.map((img, index) => `
                    <img src="${img}" alt="Ảnh ${index + 1}" class="w-full h-24 object-cover rounded cursor-pointer hover:opacity-75" 
                         onclick="changeMainImage('${img}')">
                `).join('');
            }

            // Amenities
            const amenitiesContainer = document.getElementById('property-amenities');
            const amenities = property.amenities || [];
            if (amenities.length > 0) {
                amenitiesContainer.innerHTML = amenities.map(amenity => `
                    <div class="flex items-center text-gray-700">
                        <i class="fas fa-check-circle text-green-500 mr-2"></i>
                        ${amenity}
                    </div>
                `).join('');
            } else {
                amenitiesContainer.innerHTML = '<p class="text-gray-500 italic">Không có thông tin tiện nghi</p>';
            }

            // Landlord info
            if (property.landlord) {
                document.getElementById('landlord-name').textContent = property.landlord.name || 'Chủ nhà';
                
                // Store landlord info for call and chat functions
                landlordPhone = property.landlord.phone || '';
                landlordId = property.landlord._id || property.landlord;
                currentPropertyId = property._id;
                
                const phoneContainer = document.getElementById('landlord-phone');
                phoneContainer.innerHTML = `
                    <i class="fas fa-phone mr-3 text-green-500 text-lg"></i>
                    <span class="font-semibold">${property.landlord.phone || 'Chưa cập nhật'}</span>
                `;
                
                const emailContainer = document.getElementById('landlord-email');
                emailContainer.innerHTML = `
                    <i class="fas fa-envelope mr-3 text-blue-500 text-lg"></i>
                    <span class="font-semibold text-sm break-all">${property.landlord.email || 'Chưa cập nhật'}</span>
                `;
                
                // Avatar
                const avatar = property.landlord.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(property.landlord.name || 'User')}&background=4F46E5&color=fff&bold=true`;
                document.getElementById('landlord-avatar').src = avatar;
            }
        }

        function initializeMap(property) {
            if (!property.location || !property.location.coordinates || property.location.coordinates.length < 2) {
                document.getElementById('map').innerHTML = '<p class="text-center text-gray-500 py-20">Chưa có thông tin vị trí</p>';
                return;
            }

            const [lng, lat] = property.location.coordinates;

            // Create map
            const map = L.map('map').setView([lat, lng], 15);

            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(map);

            // Add marker
            const marker = L.marker([lat, lng]).addTo(map);
            marker.bindPopup(`
                <div class="text-center">
                    <strong class="text-gray-900">${property.title}</strong><br>
                    <span class="text-sm text-gray-600">${property.address.district}, ${property.address.city}</span>
                </div>
            `).openPopup();

            // Add circle
            L.circle([lat, lng], {
                color: '#3b82f6',
                fillColor: '#3b82f6',
                fillOpacity: 0.1,
                radius: 500
            }).addTo(map);
        }

        function changeMainImage(src) {
            document.getElementById('main-image').innerHTML = `<img src="${src}" alt="Main image" class="w-full h-full object-cover">`;
        }

        function getPropertyTypeLabel(type) {
            const types = {
                'phong-tro': 'Phòng trọ',
                'nha-nguyen-can': 'Nhà nguyên căn',
                'can-ho': 'Căn hộ',
                'chung-cu-mini': 'Chung cư mini',
                'homestay': 'Homestay'
            };
            return types[type] || type;
        }

        // Load property on page load
        loadPropertyDetail();

        // Mobile menu toggle
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const mobileMenu = document.getElementById('mobileMenu');
        if (mobileMenuBtn && mobileMenu) {
            mobileMenuBtn.addEventListener('click', function() {
                mobileMenu.classList.toggle('hidden');
            });
        }

        // Handle logout
        function handleLogout(event) {
            event.preventDefault();
            localStorage.removeItem('token');
            localStorage.removeItem('userData');
            window.location.href = '/';
        }

        /**
         * Handle Call - Gọi điện cho chủ nhà
         */
        function handleCall() {
            if (!landlordPhone || landlordPhone === 'Chưa cập nhật') {
                // Show error notification if no phone number
                showNotification('Chủ nhà chưa cập nhật số điện thoại', 'error');
                return;
            }
            
            // Clean phone number (remove spaces and special characters)
            const cleanPhone = landlordPhone.replace(/[\s\-\(\)]/g, '');
            
            // Validate phone number format
            if (!cleanPhone.match(/^[0-9]{10,11}$/)) {
                showNotification('Số điện thoại không hợp lệ', 'error');
                return;
            }
            
            // Show confirmation dialog with styled modal
            showCallConfirmation(landlordPhone);
        }

        /**
         * Show Call Confirmation Modal
         */
        function showCallConfirmation(phone) {
            const modal = document.createElement('div');
            modal.id = 'callModal';
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 animate-fadeIn';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md mx-4 transform animate-fadeInUp">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-phone text-green-600 text-2xl"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900 mb-2">Gọi điện cho chủ nhà</h3>
                        <p class="text-gray-600">Bạn muốn gọi đến số:</p>
                        <div class="mt-3 text-2xl font-bold text-green-600">${phone}</div>
                    </div>
                    
                    <div class="flex gap-3">
                        <button onclick="cancelCall()" class="flex-1 px-6 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-all duration-300 font-semibold">
                            <i class="fas fa-times mr-2"></i>Hủy
                        </button>
                        <button onclick="makeCall('${phone}')" class="flex-1 px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg hover:from-green-600 hover:to-green-700 transition-all duration-300 font-semibold shadow-md hover:shadow-lg">
                            <i class="fas fa-phone mr-2"></i>Gọi ngay
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Prevent body scroll
            document.body.style.overflow = 'hidden';
        }

        /**
         * Make Call - Thực hiện cuộc gọi
         */
        function makeCall(phone) {
            const cleanPhone = phone.replace(/[\s\-\(\)]/g, '');
            
            // Close modal
            cancelCall();
            
            // For mobile devices, use tel: protocol
            if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                window.location.href = `tel:${cleanPhone}`;
                showNotification('Đang khởi tạo cuộc gọi...', 'success');
            } else {
                // For desktop, show copy phone number option
                showDesktopCallOptions(phone);
            }
        }

        /**
         * Show Desktop Call Options
         */
        function showDesktopCallOptions(phone) {
            const modal = document.createElement('div');
            modal.id = 'desktopCallModal';
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 animate-fadeIn';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md mx-4 transform animate-fadeInUp">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-desktop text-blue-600 text-2xl"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900 mb-2">Số điện thoại</h3>
                        <p class="text-gray-600 mb-4">Vui lòng sử dụng điện thoại để gọi:</p>
                        <div class="bg-gray-100 rounded-lg p-4 mb-4">
                            <div class="text-2xl font-bold text-gray-900" id="phoneNumberDisplay">${phone}</div>
                        </div>
                    </div>
                    
                    <div class="flex gap-3">
                        <button onclick="closeDesktopCallModal()" class="flex-1 px-6 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-all duration-300 font-semibold">
                            <i class="fas fa-times mr-2"></i>Đóng
                        </button>
                        <button onclick="copyPhoneNumber('${phone}')" class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg hover:from-blue-600 hover:to-blue-700 transition-all duration-300 font-semibold shadow-md hover:shadow-lg">
                            <i class="fas fa-copy mr-2"></i>Sao chép
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Prevent body scroll
            document.body.style.overflow = 'hidden';
        }

        /**
         * Copy Phone Number to Clipboard
         */
        function copyPhoneNumber(phone) {
            const cleanPhone = phone.replace(/[\s\-\(\)]/g, '');
            
            navigator.clipboard.writeText(cleanPhone).then(() => {
                showNotification('Đã sao chép số điện thoại!', 'success');
                closeDesktopCallModal();
            }).catch(err => {
                console.error('Failed to copy:', err);
                showNotification('Không thể sao chép. Vui lòng thử lại.', 'error');
            });
        }

        /**
         * Cancel Call - Đóng modal xác nhận
         */
        function cancelCall() {
            const modal = document.getElementById('callModal');
            if (modal) {
                modal.remove();
                document.body.style.overflow = 'auto';
            }
        }

        /**
         * Close Desktop Call Modal
         */
        function closeDesktopCallModal() {
            const modal = document.getElementById('desktopCallModal');
            if (modal) {
                modal.remove();
                document.body.style.overflow = 'auto';
            }
        }

        /**
         * Show Notification
         */
        function showNotification(message, type = 'success') {
            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-4 rounded-lg shadow-lg z-50 ${bgColor} text-white animate-slideDown flex items-center gap-3`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} text-xl"></i>
                <span class="font-semibold">${message}</span>
            `;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        /**
         * Handle Message - Mở chat với chủ nhà
         */
        async function handleMessage() {
            // Kiểm tra đã đăng nhập chưa
            const token = localStorage.getItem('token');
            if (!token) {
                showNotification('Vui lòng đăng nhập để gửi tin nhắn', 'error');
                setTimeout(() => {
                    window.location.href = '/auth/login';
                }, 1500);
                return;
            }

            // Kiểm tra có landlordId không
            if (!landlordId) {
                showNotification('Không tìm thấy thông tin chủ nhà', 'error');
                return;
            }

            try {
                // Tạo hoặc lấy conversation với landlord
                const response = await fetch('/api/chat/conversations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        userId: landlordId,
                        propertyId: currentPropertyId
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Lưu conversation ID vào localStorage để chat.js mở
                    localStorage.setItem('openConversationId', data.data._id);
                    localStorage.setItem('openConversationUser', JSON.stringify(data.data.participants.find(p => p._id !== landlordId)));
                    
                    // Chuyển đến trang chat
                    window.location.href = '/chat';
                } else {
                    showNotification(data.message || 'Không thể mở chat', 'error');
                }
            } catch (error) {
                console.error('Error opening chat:', error);
                showNotification('Có lỗi xảy ra khi mở chat', 'error');
            }
        }

        /**
         * Open Booking Modal
         */
        function openBookingModal() {
            // Kiểm tra đã đăng nhập chưa
            const token = localStorage.getItem('token');
            const userData = localStorage.getItem('userData');
            
            if (!token || !userData) {
                showNotification('Vui lòng đăng nhập để đặt lịch xem phòng', 'error');
                setTimeout(() => {
                    window.location.href = '/auth/login';
                }, 1500);
                return;
            }

            // Pre-fill user data
            try {
                const user = JSON.parse(userData);
                document.getElementById('bookingName').value = user.name || '';
                document.getElementById('bookingPhone').value = user.phone || '';
            } catch (error) {
                console.error('Error parsing user data:', error);
            }

            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('bookingDate').setAttribute('min', today);

            // Show modal
            const modal = document.getElementById('bookingModal');
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        /**
         * Close Booking Modal
         */
        function closeBookingModal() {
            const modal = document.getElementById('bookingModal');
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
            
            // Reset form
            document.getElementById('bookingForm').reset();
        }

        /**
         * Handle Booking Form Submit
         */
        document.getElementById('bookingForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();

            const token = localStorage.getItem('token');
            if (!token) {
                showNotification('Vui lòng đăng nhập', 'error');
                return;
            }

            // Get form data
            const formData = {
                property: currentPropertyId,
                name: document.getElementById('bookingName').value,
                phone: document.getElementById('bookingPhone').value,
                viewingDate: document.getElementById('bookingDate').value,
                viewingTime: document.getElementById('bookingTime').value,
                note: document.getElementById('bookingNote').value
            };

            try {
                const response = await fetch('/api/bookings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('Đặt lịch xem phòng thành công! Chủ nhà sẽ liên hệ lại với bạn.', 'success');
                    closeBookingModal();
                    
                    // Optionally redirect to bookings page after 2 seconds
                    setTimeout(() => {
                        if (confirm('Bạn có muốn xem danh sách lịch hẹn của mình không?')) {
                            window.location.href = '/bookings';
                        }
                    }, 2000);
                } else {
                    showNotification(result.message || 'Không thể đặt lịch. Vui lòng thử lại!', 'error');
                }
            } catch (error) {
                console.error('Error creating booking:', error);
                showNotification('Có lỗi xảy ra. Vui lòng thử lại!', 'error');
            }
        });

        /**
         * Open Report Modal
         */
        function openReportModal() {
            const token = localStorage.getItem('token');
            const userData = localStorage.getItem('userData');
            
            if (!token || !userData) {
                showNotification('Vui lòng đăng nhập để báo cáo tin đăng', 'error');
                setTimeout(() => {
                    window.location.href = '/auth/login';
                }, 1500);
                return;
            }

            // Pre-fill email if available
            try {
                const user = JSON.parse(userData);
                document.getElementById('reportEmail').value = user.email || '';
            } catch (error) {
                console.error('Error parsing user data:', error);
            }

            // Show modal
            const modal = document.getElementById('reportModal');
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        /**
         * Close Report Modal
         */
        function closeReportModal() {
            const modal = document.getElementById('reportModal');
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
            
            // Reset form
            document.getElementById('reportForm').reset();
        }

        /**
         * Handle Report Form Submit
         */
        document.getElementById('reportForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();

            const token = localStorage.getItem('token');
            if (!token) {
                showNotification('Vui lòng đăng nhập', 'error');
                return;
            }

            const formData = {
                property: currentPropertyId,
                reason: document.getElementById('reportReason').value,
                description: document.getElementById('reportDescription').value,
                email: document.getElementById('reportEmail').value
            };

            try {
                // Note: Bạn cần tạo API endpoint /api/reports
                const response = await fetch('/api/reports', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('Cảm ơn bạn đã báo cáo. Chúng tôi sẽ xem xét trong thời gian sớm nhất.', 'success');
                    closeReportModal();
                } else {
                    showNotification(result.message || 'Không thể gửi báo cáo. Vui lòng thử lại!', 'error');
                }
            } catch (error) {
                console.error('Error submitting report:', error);
                // Tạm thời cho phép submit mà không có API
                showNotification('Cảm ơn bạn đã báo cáo. Chúng tôi sẽ xem xét trong thời gian sớm nhất.', 'success');
                closeReportModal();
            }
        });

        /**
         * Load Reviews
         */
        let currentReviewsPage = 1;
        let totalReviewsCount = 0;
        
        async function loadReviews() {
            try {
                const response = await fetch(`/api/reviews?property=${currentPropertyId}`);
                const result = await response.json();

                if (result.success) {
                    totalReviewsCount = result.count;
                    displayReviews(result.data);
                    calculateRatingSummary(result.data);
                }
            } catch (error) {
                console.error('Error loading reviews:', error);
            }
        }

        /**
         * Display Reviews
         */
        function displayReviews(reviews) {
            const reviewsList = document.getElementById('reviewsList');
            
            if (reviews.length === 0) {
                reviewsList.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-comments text-4xl mb-3 opacity-50"></i>
                        <p>Chưa có đánh giá nào. Hãy là người đầu tiên đánh giá!</p>
                    </div>
                `;
                return;
            }

            reviewsList.innerHTML = reviews.map(review => `
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                    <div class="flex items-start space-x-3">
                        <img src="${review.user?.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(review.user?.name || 'User')}&background=4F46E5&color=fff`}" 
                             alt="${review.user?.name}" 
                             class="w-12 h-12 rounded-full object-cover">
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-2">
                                <div>
                                    <h4 class="font-semibold text-gray-900">${review.user?.name || 'Người dùng'}</h4>
                                    <div class="flex items-center text-yellow-500 text-sm">
                                        ${generateStars(review.rating)}
                                        <span class="ml-2 text-gray-600">${review.rating}.0</span>
                                    </div>
                                </div>
                                <span class="text-sm text-gray-500">${formatDate(review.createdAt)}</span>
                            </div>
                            <h5 class="font-semibold text-gray-800 mb-1">${review.title}</h5>
                            <p class="text-gray-600 text-sm leading-relaxed">${review.comment}</p>
                            ${review.verified ? '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-green-100 text-green-700 mt-2"><i class="fas fa-check-circle mr-1"></i>Đã xác minh</span>' : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        /**
         * Calculate Rating Summary
         */
        function calculateRatingSummary(reviews) {
            if (reviews.length === 0) {
                document.getElementById('averageRating').textContent = '0.0';
                document.getElementById('averageStars').innerHTML = generateStars(0);
                document.getElementById('totalReviews').textContent = '0 đánh giá';
                return;
            }

            const totalRating = reviews.reduce((sum, r) => sum + r.rating, 0);
            const averageRating = (totalRating / reviews.length).toFixed(1);

            document.getElementById('averageRating').textContent = averageRating;
            document.getElementById('averageStars').innerHTML = generateStars(Math.round(averageRating));
            document.getElementById('totalReviews').textContent = `${reviews.length} đánh giá`;

            // Rating bars
            const ratingCounts = [0, 0, 0, 0, 0];
            reviews.forEach(r => ratingCounts[r.rating - 1]++);

            const ratingBars = document.getElementById('ratingBars');
            ratingBars.innerHTML = [5, 4, 3, 2, 1].map(star => {
                const count = ratingCounts[star - 1];
                const percentage = reviews.length > 0 ? (count / reviews.length * 100) : 0;
                return `
                    <div class="flex items-center text-xs">
                        <span class="w-8">${star}★</span>
                        <div class="flex-1 h-2 bg-gray-200 rounded-full mx-2">
                            <div class="h-full bg-yellow-500 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                        <span class="w-8 text-right">${count}</span>
                    </div>
                `;
            }).join('');
        }

        /**
         * Generate Stars HTML
         */
        function generateStars(rating) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                stars += i <= rating 
                    ? '<i class="fas fa-star"></i>' 
                    : '<i class="far fa-star"></i>';
            }
            return stars;
        }

        /**
         * Format Date
         */
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'Hôm nay';
            if (diffDays === 1) return 'Hôm qua';
            if (diffDays < 7) return `${diffDays} ngày trước`;
            if (diffDays < 30) return `${Math.floor(diffDays / 7)} tuần trước`;
            if (diffDays < 365) return `${Math.floor(diffDays / 30)} tháng trước`;
            return date.toLocaleDateString('vi-VN');
        }

        /**
         * Open Review Modal
         */
        function openReviewModal() {
            const token = localStorage.getItem('token');
            if (!token) {
                showNotification('Vui lòng đăng nhập để viết đánh giá', 'error');
                setTimeout(() => {
                    window.location.href = '/auth/login';
                }, 1500);
                return;
            }

            const modal = document.getElementById('reviewModal');
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';

            // Initialize star rating
            initializeStarRating();
        }

        /**
         * Close Review Modal
         */
        function closeReviewModal() {
            const modal = document.getElementById('reviewModal');
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
            document.getElementById('reviewForm').reset();
            document.getElementById('reviewRating').value = '';
            resetStars();
        }

        /**
         * Initialize Star Rating
         */
        function initializeStarRating() {
            const stars = document.querySelectorAll('#reviewStars i');
            const ratingInput = document.getElementById('reviewRating');
            const ratingText = document.getElementById('ratingText');

            const ratingLabels = ['Rất tệ', 'Tệ', 'Bình thường', 'Tốt', 'Xuất sắc'];

            stars.forEach(star => {
                star.addEventListener('click', function() {
                    const rating = parseInt(this.dataset.rating);
                    ratingInput.value = rating;
                    ratingText.textContent = ratingLabels[rating - 1];
                    updateStars(rating);
                });

                star.addEventListener('mouseenter', function() {
                    const rating = parseInt(this.dataset.rating);
                    updateStars(rating);
                });
            });

            document.getElementById('reviewStars').addEventListener('mouseleave', function() {
                const currentRating = parseInt(ratingInput.value) || 0;
                updateStars(currentRating);
            });
        }

        /**
         * Update Stars Display
         */
        function updateStars(rating) {
            const stars = document.querySelectorAll('#reviewStars i');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.remove('far');
                    star.classList.add('fas', 'text-yellow-500');
                } else {
                    star.classList.remove('fas', 'text-yellow-500');
                    star.classList.add('far');
                }
            });
        }

        /**
         * Reset Stars
         */
        function resetStars() {
            const stars = document.querySelectorAll('#reviewStars i');
            stars.forEach(star => {
                star.classList.remove('fas', 'text-yellow-500');
                star.classList.add('far');
            });
            document.getElementById('ratingText').textContent = 'Chọn số sao';
        }

        /**
         * Handle Review Form Submit
         */
        document.getElementById('reviewForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();

            const token = localStorage.getItem('token');
            if (!token) {
                showNotification('Vui lòng đăng nhập', 'error');
                return;
            }

            const rating = document.getElementById('reviewRating').value;
            if (!rating) {
                showNotification('Vui lòng chọn số sao đánh giá', 'error');
                return;
            }

            const formData = {
                property: currentPropertyId,
                rating: parseInt(rating),
                title: document.getElementById('reviewTitle').value,
                comment: document.getElementById('reviewComment').value
            };

            try {
                const response = await fetch('/api/reviews', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('Cảm ơn bạn đã đánh giá!', 'success');
                    closeReviewModal();
                    loadReviews(); // Reload reviews
                } else {
                    showNotification(result.message || 'Không thể gửi đánh giá. Vui lòng thử lại!', 'error');
                }
            } catch (error) {
                console.error('Error submitting review:', error);
                showNotification('Có lỗi xảy ra. Vui lòng thử lại!', 'error');
            }
        });

        // Check if user is logged in and update UI
        const userData = localStorage.getItem('userData');
        if (userData) {
            try {
                const user = JSON.parse(userData);
                document.getElementById('navbarGuest').style.display = 'none';
                document.getElementById('navbarUser').style.display = 'flex';
                
                // Update user info
                document.getElementById('userName').textContent = user.name || 'Người dùng';
                document.getElementById('userEmail').textContent = user.email || 'user@example.com';
                
                // Update avatar
                if (user.avatar) {
                    document.getElementById('userAvatar').src = user.avatar;
                } else {
                    const initials = (user.name || 'U').split(' ').map(n => n[0]).join('').toUpperCase();
                    const colors = ['6B7280', '4B5563', '374151'];
                    const bgColor = colors[Math.floor(Math.random() * colors.length)];
                    document.getElementById('userAvatar').src = `https://ui-avatars.com/api/?name=${initials}&background=${bgColor}&color=fff`;
                }
                
                // Show admin panel button if user is admin
                if (user.role === 'admin') {
                    document.getElementById('adminPanelBtn').style.display = 'block';
                }
                
                // Update mobile menu
                document.getElementById('mobileLoginBtn').style.display = 'none';
                document.getElementById('mobileRegisterBtn').style.display = 'none';
            } catch (e) {
                console.error('Error parsing user data:', e);
            }
        }

        /**
         * Handle Save Property (Favorite)
         */
        async function handleSaveProperty(event) {
            event.preventDefault();
            
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/auth/login';
                return;
            }

            const btn = event.currentTarget;
            const isSaved = btn.classList.contains('favorite-active');
            
            try {
                const method = isSaved ? 'DELETE' : 'POST';
                const response = await fetch(`/api/favorites/${propertyId}`, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    if (isSaved) {
                        // Remove from favorites
                        btn.classList.remove('favorite-active');
                        btn.classList.remove('bg-gradient-to-r', 'from-pink-500', 'to-red-500', 'text-white', 'border-red-500');
                        btn.classList.add('bg-gradient-to-r', 'from-pink-100', 'to-red-100', 'text-red-600', 'hover:from-pink-200', 'hover:to-red-200', 'border-2', 'border-red-200');
                        btn.innerHTML = '<i class="far fa-heart mr-2"></i> Lưu tin';
                    } else {
                        // Add to favorites
                        btn.classList.add('favorite-active');
                        btn.classList.remove('bg-gradient-to-r', 'from-pink-100', 'to-red-100', 'text-red-600', 'hover:from-pink-200', 'hover:to-red-200', 'border-2', 'border-red-200');
                        btn.classList.add('bg-gradient-to-r', 'from-pink-500', 'to-red-500', 'text-white', 'border-red-500');
                        btn.innerHTML = '<i class="fas fa-heart mr-2"></i> Đã lưu';
                    }
                    
                    // Show notification
                    const message = isSaved ? 'Đã xóa khỏi yêu thích' : 'Đã lưu tin này';
                    showSaveNotification(message);
                }
            } catch (error) {
                console.error('Lỗi:', error);
            }
        }

        /**
         * Show Save Notification
         */
        function showSaveNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 bg-green-500 text-white animate-slideDown';
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        /**
         * Check if property is favorited when page loads
         */
        async function checkIfFavorited() {
            const token = localStorage.getItem('token');
            if (!token) return;

            try {
                const response = await fetch(`/api/favorites/check/${propertyId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const result = await response.json();
                    const btn = document.getElementById('saveBtn');
                    
                    if (result.isFavorite) {
                        btn.classList.add('favorite-active');
                        btn.classList.remove('bg-gradient-to-r', 'from-pink-100', 'to-red-100', 'text-red-600', 'hover:from-pink-200', 'hover:to-red-200', 'border-2', 'border-red-200');
                        btn.classList.add('bg-gradient-to-r', 'from-pink-500', 'to-red-500', 'text-white', 'border-red-500');
                        btn.innerHTML = '<i class="fas fa-heart mr-2"></i> Đã lưu';
                    }
                }
            } catch (error) {
                console.error('Lỗi kiểm tra yêu thích:', error);
            }
        }

        // Check favorite status when page loads
        window.addEventListener('load', function() {
            checkIfFavorited();
            loadReviews();
        });
    </script>
    
    <!-- Property Detail Script -->
    <script src="/js/property-detail.js"></script>
</body>
</html>
