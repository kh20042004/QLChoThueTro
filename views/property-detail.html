<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi ti·∫øt ph√≤ng - HomeRent</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        html { scroll-behavior: smooth; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #F3F4F6;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #9CA3AF;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #6B7280;
        }

        /* Animation slideDown for dropdown */
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .animate-slideDown {
            animation: slideDown 0.3s ease-out;
        }

        .property-gallery img {
            cursor: pointer;
            transition: transform 0.3s;
        }

        .property-gallery img:hover {
            transform: scale(1.05);
        }

        #map {
            height: 400px;
            border-radius: 12px;
        }

        /* Button Save/Favorite Styling */
        #saveBtn {
            text-transform: none !important;
            font-size: inherit !important;
            letter-spacing: normal !important;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Radial Gradient Background - Fixed Full Page -->
    <div class="fixed inset-0 w-full h-full z-0" style="background: radial-gradient(125% 125% at 50% 10%, #fff 40%, #1d2125 100%);"></div>
    
    <!-- Content Wrapper -->
    <div class="relative z-10">
        <!-- Header -->
        <header class="sticky top-0 z-50 bg-white/80 backdrop-blur-md shadow-sm">
            <nav class="container mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <!-- Logo -->
                    <a href="/" class="flex items-center space-x-2 group">
                        <i class="fas fa-home text-2xl text-gray-600 group-hover:text-gray-800 transition-colors duration-300"></i>
                        <span class="text-xl font-bold text-gray-800">HomeRent</span>
                    </a>
                    
                    <!-- Desktop Menu -->
                    <div class="hidden md:flex items-center space-x-8">
                        <a href="/" class="text-gray-700 hover:text-gray-900 transition-colors duration-300 relative group">
                            Trang ch·ªß
                            <span class="absolute bottom-0 left-0 w-0 h-0.5 bg-gray-800 group-hover:w-full transition-all duration-300"></span>
                        </a>
                        <a href="/properties" class="text-gray-700 hover:text-gray-900 transition-colors duration-300 relative group">
                            T√¨m ph√≤ng
                            <span class="absolute bottom-0 left-0 w-0 h-0.5 bg-gray-800 group-hover:w-full transition-all duration-300"></span>
                        </a>
                        <a href="/universities" class="text-gray-700 hover:text-gray-900 transition-colors duration-300 relative group">
                            üéì Tr∆∞·ªùng ƒêH
                            <span class="absolute bottom-0 left-0 w-0 h-0.5 bg-gray-800 group-hover:w-full transition-all duration-300"></span>
                        </a>
                        <a href="/about" class="text-gray-700 hover:text-gray-900 transition-colors duration-300 relative group">
                            Gi·ªõi thi·ªáu
                            <span class="absolute bottom-0 left-0 w-0 h-0.5 bg-gray-800 group-hover:w-full transition-all duration-300"></span>
                        </a>
                        <a href="/contact" class="text-gray-700 hover:text-gray-900 transition-colors duration-300 relative group">
                            Li√™n h·ªá
                            <span class="absolute bottom-0 left-0 w-0 h-0.5 bg-gray-800 group-hover:w-full transition-all duration-300"></span>
                        </a>
                    </div>
                    
                    <!-- Auth Buttons (Guest) -->
                    <div class="hidden md:flex items-center space-x-3" id="navbarGuest">
                        <a href="/auth/login" class="px-4 py-2 text-gray-700 hover:text-gray-900 transition-colors duration-300">
                            <i class="fas fa-sign-in-alt mr-1"></i>ƒêƒÉng nh·∫≠p
                        </a>
                        <a href="/auth/register" class="px-5 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition-all duration-300 shadow-sm hover:shadow-md">
                            <i class="fas fa-user-plus mr-1"></i>ƒêƒÉng k√Ω
                        </a>
                    </div>
                    
                    <!-- User Menu (Logged in) -->
                    <div class="hidden md:flex items-center space-x-4" id="navbarUser" style="display: none;">
                        <!-- Notifications -->
                        <a href="/notifications" class="relative p-2 text-gray-600 hover:text-gray-900 transition-colors duration-300">
                            <i class="fas fa-bell text-xl"></i>
                            <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs w-5 h-5 flex items-center justify-center rounded-full">3</span>
                        </a>
                        
                        <!-- Favorites -->
                        <a href="/favorites" class="relative p-2 text-gray-600 hover:text-gray-900 transition-colors duration-300">
                            <i class="fas fa-heart text-xl"></i>
                            <span id="favoriteBadge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs w-5 h-5 flex items-center justify-center rounded-full">0</span>
                        </a>
                        
                        <!-- Post Property -->
                        <a href="/property/create" class="px-5 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition-all duration-300 shadow-sm hover:shadow-md">
                            <i class="fas fa-plus mr-1"></i>ƒêƒÉng tin
                        </a>
                        
                        <!-- Admin Panel Button (Only for admin) -->
                        <a href="/admin/dashboard" id="adminPanelBtn" style="display: none;" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg hover:from-purple-700 hover:to-pink-700 transition-all duration-300 shadow-sm hover:shadow-md">
                            <i class="fas fa-crown mr-1"></i>Admin
                        </a>
                        
                        <!-- User Dropdown -->
                        <div class="relative group">
                            <button class="flex items-center space-x-2">
                                <img src="https://via.placeholder.com/40/6B7280/ffffff?text=U" alt="Avatar" class="w-8 h-8 rounded-full border-2 border-gray-300" id="userAvatar">
                                <span class="text-gray-700" id="userName">Ng∆∞·ªùi d√πng</span>
                                <i class="fas fa-chevron-down text-xs text-gray-500"></i>
                            </button>
                            
                            <div class="absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-lg border border-gray-100 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 animate-slideDown">
                                <div class="p-3 border-b border-gray-100">
                                    <p class="text-sm text-gray-500" id="userEmail">user@example.com</p>
                                </div>
                                <a href="/profile" class="block px-4 py-2 text-gray-700 hover:bg-gray-50 transition-colors duration-200">
                                    <i class="fas fa-user mr-2 text-gray-500"></i>H·ªì s∆° c√° nh√¢n
                                </a>
                                <a href="/bookings" class="block px-4 py-2 text-gray-700 hover:bg-gray-50 transition-colors duration-200">
                                    <i class="fas fa-calendar mr-2 text-gray-500"></i>ƒê∆°n ƒë·∫∑t ph√≤ng
                                </a>
                                <a href="/my-properties" class="block px-4 py-2 text-gray-700 hover:bg-gray-50 transition-colors duration-200">
                                    <i class="fas fa-home mr-2 text-gray-500"></i>Nh√†/ph√≤ng c·ªßa t√¥i
                                </a>
                                <a href="/settings" class="block px-4 py-2 text-gray-700 hover:bg-gray-50 transition-colors duration-200">
                                    <i class="fas fa-cog mr-2 text-gray-500"></i>C√†i ƒë·∫∑t
                                </a>
                                <div class="border-t border-gray-100"></div>
                                <a href="/logout" onclick="handleLogout(event)" class="block px-4 py-2 text-red-600 hover:bg-gray-50 transition-colors duration-200">
                                    <i class="fas fa-sign-out-alt mr-2"></i>ƒêƒÉng xu·∫•t
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mobile Menu Button -->
                    <button class="md:hidden text-gray-700" id="mobileMenuBtn">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
                
                <!-- Mobile Menu -->
                <div class="hidden md:hidden mt-4 pb-4 border-t border-gray-100" id="mobileMenu">
                    <div class="flex flex-col space-y-3 mt-4">
                        <a href="/" class="text-gray-700 hover:text-gray-900 py-2">Trang ch·ªß</a>
                        <a href="/properties" class="text-gray-700 hover:text-gray-900 py-2">T√¨m ph√≤ng</a>
                        <a href="/universities" class="text-gray-700 hover:text-gray-900 py-2">üéì Tr∆∞·ªùng ƒêH</a>
                        <a href="/about" class="text-gray-700 hover:text-gray-900 py-2">Gi·ªõi thi·ªáu</a>
                        <a href="/contact" class="text-gray-700 hover:text-gray-900 py-2">Li√™n h·ªá</a>
                        <a href="/auth/login" class="text-gray-700 hover:text-gray-900 py-2" id="mobileLoginBtn">ƒêƒÉng nh·∫≠p</a>
                        <a href="/auth/register" class="text-gray-700 hover:text-gray-900 py-2" id="mobileRegisterBtn">ƒêƒÉng k√Ω</a>
                    </div>
                </div>
            </nav>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-8">
        <!-- Breadcrumb -->
        <nav class="mb-6">
            <ol class="flex items-center space-x-2 text-sm text-gray-600">
                <li><a href="/" class="hover:text-gray-900">Trang ch·ªß</a></li>
                <li><i class="fas fa-chevron-right text-xs"></i></li>
                <li><a href="/properties" class="hover:text-gray-900">Nh√†/Ph√≤ng</a></li>
                <li><i class="fas fa-chevron-right text-xs"></i></li>
                <li class="text-gray-900 font-medium" id="breadcrumb-title">Chi ti·∫øt</li>
            </ol>
        </nav>

        <!-- Loading State -->
        <div id="loading" class="flex justify-center items-center py-20">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900 mx-auto mb-4"></div>
                <p class="text-gray-600">ƒêang t·∫£i th√¥ng tin...</p>
            </div>
        </div>

        <!-- Property Detail -->
        <div id="property-detail" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Left Column -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Image Gallery -->
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <div id="main-image" class="h-96 bg-gray-200"></div>
                        <div id="thumbnail-gallery" class="grid grid-cols-4 gap-2 p-4"></div>
                    </div>

                    <!-- Property Info -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex items-start justify-between mb-4">
                            <div>
                                <span id="property-type" class="inline-block px-3 py-1 bg-gray-100 text-gray-700 text-sm rounded-full mb-2"></span>
                                <h1 id="property-title" class="text-3xl font-bold text-gray-900 mb-2"></h1>
                                <p id="property-address" class="text-gray-600">
                                    <i class="fas fa-map-marker-alt mr-2"></i>
                                </p>
                            </div>
                            <div class="text-right">
                                <div id="property-price" class="text-3xl font-bold text-gray-900"></div>
                                <div class="text-sm text-gray-500">/ th√°ng</div>
                            </div>
                        </div>

                        <!-- Stats -->
                        <div class="grid grid-cols-3 gap-4 py-4 border-t border-b border-gray-200">
                            <div class="text-center">
                                <i class="fas fa-expand-arrows-alt text-gray-400 mb-1"></i>
                                <div id="property-area" class="font-semibold text-gray-900"></div>
                                <div class="text-sm text-gray-500">Di·ªán t√≠ch</div>
                            </div>
                            <div class="text-center">
                                <i class="fas fa-bed text-gray-400 mb-1"></i>
                                <div id="property-bedrooms" class="font-semibold text-gray-900"></div>
                                <div class="text-sm text-gray-500">Ph√≤ng ng·ªß</div>
                            </div>
                            <div class="text-center">
                                <i class="fas fa-bath text-gray-400 mb-1"></i>
                                <div id="property-bathrooms" class="font-semibold text-gray-900"></div>
                                <div class="text-sm text-gray-500">Ph√≤ng t·∫Øm</div>
                            </div>
                        </div>

                        <!-- Description -->
                        <div class="mt-6">
                            <h2 class="text-xl font-bold text-gray-900 mb-3">M√¥ t·∫£</h2>
                            <div id="property-description" class="text-gray-700 leading-relaxed"></div>
                        </div>

                        <!-- Amenities -->
                        <div class="mt-6">
                            <h2 class="text-xl font-bold text-gray-900 mb-3">Ti·ªán nghi</h2>
                            <div id="property-amenities" class="grid grid-cols-2 md:grid-cols-3 gap-3"></div>
                        </div>
                    </div>

                    <!-- Map -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h2 class="text-xl font-bold text-gray-900 mb-4">
                            <i class="fas fa-map-marker-alt text-blue-500 mr-2"></i>
                            V·ªã tr√≠ tr√™n b·∫£n ƒë·ªì
                        </h2>
                        <div id="map"></div>
                        <p class="text-sm text-gray-600 mt-3">
                            <i class="fas fa-info-circle mr-2"></i>
                            Click v√† k√©o ƒë·ªÉ di chuy·ªÉn b·∫£n ƒë·ªì. Cu·ªôn chu·ªôt ƒë·ªÉ zoom in/out.
                        </p>
                    </div>
                </div>

                <!-- Right Column - Sidebar -->
                <div class="space-y-6">
                    <!-- Contact Card -->
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl shadow-lg border-2 border-blue-100 p-6 sticky top-4">
                        <h3 class="text-xl font-bold text-gray-900 mb-5 flex items-center">
                            <i class="fas fa-address-card text-blue-600 mr-2"></i>
                            Th√¥ng tin li√™n h·ªá
                        </h3>
                        
                        <div id="landlord-info" class="mb-6">
                            <div class="flex items-center space-x-3 mb-5 p-3 bg-white rounded-lg shadow-sm">
                                <img id="landlord-avatar" src="" alt="Landlord" class="w-14 h-14 rounded-full object-cover border-3 border-blue-200 shadow">
                                <div>
                                    <div id="landlord-name" class="font-bold text-gray-900 text-lg"></div>
                                    <div class="text-sm text-blue-600 font-medium">
                                        <i class="fas fa-user-tie mr-1"></i>Ch·ªß nh√†
                                    </div>
                                </div>
                            </div>
                            <div id="landlord-phone" class="flex items-center text-gray-800 mb-3 p-3 bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow">
                                <i class="fas fa-phone mr-3 text-green-500 text-lg"></i>
                                <span class="font-semibold"></span>
                            </div>
                            <div id="landlord-email" class="flex items-center text-gray-800 p-3 bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow">
                                <i class="fas fa-envelope mr-3 text-blue-500 text-lg"></i>
                                <span class="font-semibold text-sm break-all"></span>
                            </div>
                        </div>

                        <button class="w-full bg-gradient-to-r from-gray-800 to-gray-900 text-white py-3.5 rounded-lg hover:from-gray-900 hover:to-black transition-all duration-300 mb-3 font-semibold shadow-md hover:shadow-lg transform hover:scale-105">
                            <i class="fas fa-phone mr-2"></i>G·ªçi ƒëi·ªán
                        </button>
                        <button class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white py-3.5 rounded-lg hover:from-blue-600 hover:to-blue-700 transition-all duration-300 mb-3 font-semibold shadow-md hover:shadow-lg transform hover:scale-105">
                            <i class="fas fa-envelope mr-2"></i>G·ª≠i tin nh·∫Øn
                        </button>
                        <button id="saveBtn" onclick="handleSaveProperty(event)" 
                                class="w-full py-3.5 rounded-lg transition-all duration-300 mb-3 favorite-btn font-semibold shadow-md hover:shadow-lg transform hover:scale-105 bg-gradient-to-r from-pink-100 to-red-100 text-red-600 hover:from-pink-200 hover:to-red-200 border-2 border-red-200"
                                data-favorite-property=""
                                style="text-transform: none;" 
                                title="Th√™m y√™u th√≠ch">
                            <i class="far fa-heart mr-2"></i> L∆∞u tin
                        </button>
                    </div>

                    <!-- Report Card -->
                    <div class="bg-gradient-to-br from-yellow-50 to-orange-50 border-2 border-yellow-300 rounded-xl p-5 shadow-md hover:shadow-lg transition-shadow">
                        <h4 class="font-bold text-gray-900 mb-3 flex items-center text-base">
                            <i class="fas fa-exclamation-triangle text-yellow-600 mr-2 text-xl"></i>
                            B√°o c√°o tin ƒëƒÉng
                        </h4>
                        <p class="text-sm text-gray-700 mb-4 font-medium">N·∫øu b·∫°n th·∫•y tin ƒëƒÉng n√†y c√≥ v·∫•n ƒë·ªÅ, vui l√≤ng b√°o c√°o cho ch√∫ng t√¥i.</p>
                        <button class="w-full bg-gradient-to-r from-yellow-400 to-orange-400 text-gray-900 font-bold py-2.5 px-4 rounded-lg hover:from-yellow-500 hover:to-orange-500 transition-all duration-300 shadow-sm hover:shadow-md transform hover:scale-105">
                            <i class="fas fa-flag mr-2"></i>B√°o c√°o ngay
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error State -->
        <div id="error" class="hidden text-center py-20">
            <i class="fas fa-exclamation-circle text-6xl text-red-500 mb-4"></i>
            <h2 class="text-2xl font-bold text-gray-900 mb-2">Kh√¥ng t√¨m th·∫•y b·∫•t ƒë·ªông s·∫£n</h2>
            <p class="text-gray-600 mb-6">B·∫•t ƒë·ªông s·∫£n n√†y kh√¥ng t·ªìn t·∫°i ho·∫∑c ƒë√£ b·ªã x√≥a.</p>
            <a href="/" class="inline-block px-6 py-3 bg-gray-900 text-white rounded-lg hover:bg-gray-800">
                V·ªÅ trang ch·ªß
            </a>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-900/95 backdrop-blur-sm pt-12 pb-6 text-gray-300">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8 mb-8">
                <div>
                    <h5 class="font-bold text-white mb-4 flex items-center">
                        <i class="fas fa-home mr-2"></i>HomeRent
                    </h5>
                    <p class="text-gray-400 mb-4">
                        H·ªá th·ªëng cho thu√™ nh√†/ph√≤ng tr·ªç th√¥ng minh v·ªõi c√¥ng ngh·ªá AI, gi√∫p b·∫°n t√¨m ki·∫øm v√† qu·∫£n l√Ω b·∫•t ƒë·ªông s·∫£n d·ªÖ d√†ng.
                    </p>
                    <div class="flex space-x-3">
                        <a href="#" class="text-gray-400 hover:text-white transition-colors duration-300">
                            <i class="fab fa-facebook text-xl"></i>
                        </a>
                        <a href="#" class="text-gray-400 hover:text-white transition-colors duration-300">
                            <i class="fab fa-twitter text-xl"></i>
                        </a>
                        <a href="#" class="text-gray-400 hover:text-white transition-colors duration-300">
                            <i class="fab fa-instagram text-xl"></i>
                        </a>
                        <a href="#" class="text-gray-400 hover:text-white transition-colors duration-300">
                            <i class="fab fa-youtube text-xl"></i>
                        </a>
                    </div>
                </div>
                
                <div>
                    <h6 class="font-semibold text-white mb-4">Li√™n K·∫øt</h6>
                    <ul class="space-y-2">
                        <li><a href="/" class="text-gray-400 hover:text-white transition-colors duration-300">Trang ch·ªß</a></li>
                        <li><a href="/properties" class="text-gray-400 hover:text-white transition-colors duration-300">T√¨m ph√≤ng</a></li>
                        <li><a href="/about" class="text-gray-400 hover:text-white transition-colors duration-300">Gi·ªõi thi·ªáu</a></li>
                        <li><a href="/contact" class="text-gray-400 hover:text-white transition-colors duration-300">Li√™n h·ªá</a></li>
                    </ul>
                </div>
                
                <div>
                    <h6 class="font-semibold text-white mb-4">H·ªó Tr·ª£</h6>
                    <ul class="space-y-2">
                        <li><a href="/faq" class="text-gray-400 hover:text-white transition-colors duration-300">C√¢u h·ªèi th∆∞·ªùng g·∫∑p</a></li>
                        <li><a href="/terms" class="text-gray-400 hover:text-white transition-colors duration-300">ƒêi·ªÅu kho·∫£n</a></li>
                        <li><a href="/privacy" class="text-gray-400 hover:text-white transition-colors duration-300">B·∫£o m·∫≠t</a></li>
                        <li><a href="/guide" class="text-gray-400 hover:text-white transition-colors duration-300">H∆∞·ªõng d·∫´n</a></li>
                    </ul>
                </div>
                
                <div>
                    <h6 class="font-semibold text-white mb-4">Li√™n H·ªá</h6>
                    <ul class="space-y-2 text-gray-400">
                        <li>
                            <i class="fas fa-map-marker-alt mr-2"></i>
                            123 ƒê∆∞·ªùng ABC, Qu·∫≠n 1, TP.HCM
                        </li>
                        <li>
                            <i class="fas fa-phone mr-2"></i>
                            <a href="tel:0123456789" class="hover:text-white transition-colors duration-300">0123 456 789</a>
                        </li>
                        <li>
                            <i class="fas fa-envelope mr-2"></i>
                            <a href="mailto:info@homerent.vn" class="hover:text-white transition-colors duration-300">info@homerent.vn</a>
                        </li>
                    </ul>
                </div>
            </div>
            
            <div class="border-t border-gray-700 pt-6 text-center text-gray-400">
                <p class="mb-1">
                    &copy; 2024 HomeRent. All rights reserved. Developed with 
                    <i class="fas fa-heart text-red-500"></i> by Your Team
                </p>
                <small>Phi√™n b·∫£n 1.0.0</small>
            </div>
        </div>
    </footer>
    </div>
    <!-- End Content Wrapper -->

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""></script>
    <script src="/js/auth.js"></script>
    <script src="/js/favorites.js"></script>
    
    <script>
        // Get property ID from URL
        const propertyId = window.location.pathname.split('/').pop();

        // Load property data
        async function loadPropertyDetail() {
            try {
                const response = await fetch(`/api/properties/${propertyId}`);
                
                if (!response.ok) {
                    throw new Error('Property not found');
                }

                const result = await response.json();
                const property = result.data;

                // Hide loading, show content
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('property-detail').classList.remove('hidden');

                // Populate data
                populatePropertyData(property);
                initializeMap(property);
                
            } catch (error) {
                console.error('Error loading property:', error);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('error').classList.remove('hidden');
            }
        }

        function populatePropertyData(property) {
            // Title and basic info
            document.getElementById('breadcrumb-title').textContent = property.title;
            document.getElementById('property-title').textContent = property.title;
            document.getElementById('property-type').textContent = getPropertyTypeLabel(property.propertyType);
            
            // Address
            document.getElementById('property-address').innerHTML = `
                <i class="fas fa-map-marker-alt mr-2"></i>
                ${property.address.street}, ${property.address.ward}, ${property.address.district}, ${property.address.city}
            `;

            // Price
            const price = (property.price / 1000000).toFixed(1);
            document.getElementById('property-price').textContent = price + ' tri·ªáu';

            // Stats
            document.getElementById('property-area').textContent = property.area + 'm¬≤';
            document.getElementById('property-bedrooms').textContent = property.bedrooms || 0;
            document.getElementById('property-bathrooms').textContent = property.bathrooms || 0;

            // Description
            document.getElementById('property-description').textContent = property.description;

            // Images
            if (property.images && property.images.length > 0) {
                const mainImage = document.getElementById('main-image');
                mainImage.innerHTML = `<img src="${property.images[0]}" alt="${property.title}" class="w-full h-full object-cover">`;
                
                const thumbnailGallery = document.getElementById('thumbnail-gallery');
                thumbnailGallery.innerHTML = property.images.map((img, index) => `
                    <img src="${img}" alt="·∫¢nh ${index + 1}" class="w-full h-24 object-cover rounded cursor-pointer hover:opacity-75" 
                         onclick="changeMainImage('${img}')">
                `).join('');
            }

            // Amenities
            const amenitiesContainer = document.getElementById('property-amenities');
            const amenities = property.amenities || [];
            if (amenities.length > 0) {
                amenitiesContainer.innerHTML = amenities.map(amenity => `
                    <div class="flex items-center text-gray-700">
                        <i class="fas fa-check-circle text-green-500 mr-2"></i>
                        ${amenity}
                    </div>
                `).join('');
            } else {
                amenitiesContainer.innerHTML = '<p class="text-gray-500 italic">Kh√¥ng c√≥ th√¥ng tin ti·ªán nghi</p>';
            }

            // Landlord info
            if (property.landlord) {
                document.getElementById('landlord-name').textContent = property.landlord.name || 'Ch·ªß nh√†';
                
                const phoneContainer = document.getElementById('landlord-phone');
                phoneContainer.innerHTML = `
                    <i class="fas fa-phone mr-3 text-green-500 text-lg"></i>
                    <span class="font-semibold">${property.landlord.phone || 'Ch∆∞a c·∫≠p nh·∫≠t'}</span>
                `;
                
                const emailContainer = document.getElementById('landlord-email');
                emailContainer.innerHTML = `
                    <i class="fas fa-envelope mr-3 text-blue-500 text-lg"></i>
                    <span class="font-semibold text-sm break-all">${property.landlord.email || 'Ch∆∞a c·∫≠p nh·∫≠t'}</span>
                `;
                
                // Avatar
                const avatar = property.landlord.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(property.landlord.name || 'User')}&background=4F46E5&color=fff&bold=true`;
                document.getElementById('landlord-avatar').src = avatar;
            }
        }

        function initializeMap(property) {
            if (!property.location || !property.location.coordinates || property.location.coordinates.length < 2) {
                document.getElementById('map').innerHTML = '<p class="text-center text-gray-500 py-20">Ch∆∞a c√≥ th√¥ng tin v·ªã tr√≠</p>';
                return;
            }

            const [lng, lat] = property.location.coordinates;

            // Create map
            const map = L.map('map').setView([lat, lng], 15);

            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(map);

            // Add marker
            const marker = L.marker([lat, lng]).addTo(map);
            marker.bindPopup(`
                <div class="text-center">
                    <strong class="text-gray-900">${property.title}</strong><br>
                    <span class="text-sm text-gray-600">${property.address.district}, ${property.address.city}</span>
                </div>
            `).openPopup();

            // Add circle
            L.circle([lat, lng], {
                color: '#3b82f6',
                fillColor: '#3b82f6',
                fillOpacity: 0.1,
                radius: 500
            }).addTo(map);
        }

        function changeMainImage(src) {
            document.getElementById('main-image').innerHTML = `<img src="${src}" alt="Main image" class="w-full h-full object-cover">`;
        }

        function getPropertyTypeLabel(type) {
            const types = {
                'phong-tro': 'Ph√≤ng tr·ªç',
                'nha-nguyen-can': 'Nh√† nguy√™n cƒÉn',
                'can-ho': 'CƒÉn h·ªô',
                'chung-cu-mini': 'Chung c∆∞ mini',
                'homestay': 'Homestay'
            };
            return types[type] || type;
        }

        // Load property on page load
        loadPropertyDetail();

        // Mobile menu toggle
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const mobileMenu = document.getElementById('mobileMenu');
        if (mobileMenuBtn && mobileMenu) {
            mobileMenuBtn.addEventListener('click', function() {
                mobileMenu.classList.toggle('hidden');
            });
        }

        // Handle logout
        function handleLogout(event) {
            event.preventDefault();
            localStorage.removeItem('token');
            localStorage.removeItem('userData');
            window.location.href = '/';
        }

        // Check if user is logged in and update UI
        const userData = localStorage.getItem('userData');
        if (userData) {
            try {
                const user = JSON.parse(userData);
                document.getElementById('navbarGuest').style.display = 'none';
                document.getElementById('navbarUser').style.display = 'flex';
                
                // Update user info
                document.getElementById('userName').textContent = user.name || 'Ng∆∞·ªùi d√πng';
                document.getElementById('userEmail').textContent = user.email || 'user@example.com';
                
                // Update avatar
                if (user.avatar) {
                    document.getElementById('userAvatar').src = user.avatar;
                } else {
                    const initials = (user.name || 'U').split(' ').map(n => n[0]).join('').toUpperCase();
                    const colors = ['6B7280', '4B5563', '374151'];
                    const bgColor = colors[Math.floor(Math.random() * colors.length)];
                    document.getElementById('userAvatar').src = `https://ui-avatars.com/api/?name=${initials}&background=${bgColor}&color=fff`;
                }
                
                // Show admin panel button if user is admin
                if (user.role === 'admin') {
                    document.getElementById('adminPanelBtn').style.display = 'block';
                }
                
                // Update mobile menu
                document.getElementById('mobileLoginBtn').style.display = 'none';
                document.getElementById('mobileRegisterBtn').style.display = 'none';
            } catch (e) {
                console.error('Error parsing user data:', e);
            }
        }

        /**
         * Handle Save Property (Favorite)
         */
        async function handleSaveProperty(event) {
            event.preventDefault();
            
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/auth/login';
                return;
            }

            const btn = event.currentTarget;
            const isSaved = btn.classList.contains('favorite-active');
            
            try {
                const method = isSaved ? 'DELETE' : 'POST';
                const response = await fetch(`/api/favorites/${propertyId}`, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    if (isSaved) {
                        // Remove from favorites
                        btn.classList.remove('favorite-active');
                        btn.classList.remove('bg-gradient-to-r', 'from-pink-500', 'to-red-500', 'text-white', 'border-red-500');
                        btn.classList.add('bg-gradient-to-r', 'from-pink-100', 'to-red-100', 'text-red-600', 'hover:from-pink-200', 'hover:to-red-200', 'border-2', 'border-red-200');
                        btn.innerHTML = '<i class="far fa-heart mr-2"></i> L∆∞u tin';
                    } else {
                        // Add to favorites
                        btn.classList.add('favorite-active');
                        btn.classList.remove('bg-gradient-to-r', 'from-pink-100', 'to-red-100', 'text-red-600', 'hover:from-pink-200', 'hover:to-red-200', 'border-2', 'border-red-200');
                        btn.classList.add('bg-gradient-to-r', 'from-pink-500', 'to-red-500', 'text-white', 'border-red-500');
                        btn.innerHTML = '<i class="fas fa-heart mr-2"></i> ƒê√£ l∆∞u';
                    }
                    
                    // Show notification
                    const message = isSaved ? 'ƒê√£ x√≥a kh·ªèi y√™u th√≠ch' : 'ƒê√£ l∆∞u tin n√†y';
                    showSaveNotification(message);
                }
            } catch (error) {
                console.error('L·ªói:', error);
            }
        }

        /**
         * Show Save Notification
         */
        function showSaveNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 bg-green-500 text-white animate-slideDown';
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        /**
         * Check if property is favorited when page loads
         */
        async function checkIfFavorited() {
            const token = localStorage.getItem('token');
            if (!token) return;

            try {
                const response = await fetch(`/api/favorites/check/${propertyId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const result = await response.json();
                    const btn = document.getElementById('saveBtn');
                    
                    if (result.isFavorite) {
                        btn.classList.add('favorite-active');
                        btn.classList.remove('bg-gradient-to-r', 'from-pink-100', 'to-red-100', 'text-red-600', 'hover:from-pink-200', 'hover:to-red-200', 'border-2', 'border-red-200');
                        btn.classList.add('bg-gradient-to-r', 'from-pink-500', 'to-red-500', 'text-white', 'border-red-500');
                        btn.innerHTML = '<i class="fas fa-heart mr-2"></i> ƒê√£ l∆∞u';
                    }
                }
            } catch (error) {
                console.error('L·ªói ki·ªÉm tra y√™u th√≠ch:', error);
            }
        }

        // Check favorite status when page loads
        window.addEventListener('load', checkIfFavorited);
    </script>
</body>
</html>
