<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi tiết phòng - HomeRent</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        html { scroll-behavior: smooth; }
        
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .property-gallery img {
            cursor: pointer;
            transition: transform 0.3s;
        }

        .property-gallery img:hover {
            transform: scale(1.05);
        }

        #map {
            height: 400px;
            border-radius: 12px;
        }
    </style>
</head>
<body class="bg-gray-50">
    
    <!-- Header -->
    <header class="sticky top-0 z-50 bg-white/80 backdrop-blur-md shadow-sm">
        <nav class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <!-- Logo -->
                <a href="/" class="flex items-center space-x-2 group">
                    <i class="fas fa-home text-2xl text-gray-600 group-hover:text-gray-800 transition-colors duration-300"></i>
                    <span class="text-xl font-bold text-gray-800">HomeRent</span>
                </a>
                
                <!-- Desktop Menu -->
                <div class="hidden md:flex items-center space-x-8">
                    <a href="/" class="text-gray-700 hover:text-gray-900 transition-colors duration-300">Trang chủ</a>
                    <a href="/properties" class="text-gray-700 hover:text-gray-900 transition-colors duration-300">Tìm phòng</a>
                    <a href="/about" class="text-gray-700 hover:text-gray-900 transition-colors duration-300">Giới thiệu</a>
                    <a href="/contact" class="text-gray-700 hover:text-gray-900 transition-colors duration-300">Liên hệ</a>
                </div>
                
                <!-- Auth Buttons -->
                <div class="hidden md:flex items-center space-x-3" id="navbarGuest">
                    <a href="/auth/login" class="px-4 py-2 text-gray-700 hover:text-gray-900 transition-colors duration-300">
                        <i class="fas fa-sign-in-alt mr-1"></i>Đăng nhập
                    </a>
                    <a href="/auth/register" class="px-5 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition-all duration-300">
                        <i class="fas fa-user-plus mr-1"></i>Đăng ký
                    </a>
                </div>
                
                <!-- User Menu (Logged in) -->
                <div class="hidden md:flex items-center space-x-4" id="navbarUser" style="display: none;">
                    <a href="/profile" class="text-gray-700 hover:text-gray-900">
                        <i class="fas fa-user"></i> Tài khoản
                    </a>
                    <a href="/logout" onclick="handleLogout(event)" class="text-red-600 hover:text-red-700">
                        <i class="fas fa-sign-out-alt"></i> Đăng xuất
                    </a>
                </div>
                
                <!-- Mobile Menu Button -->
                <button class="md:hidden text-gray-700" id="mobileMenuBtn">
                    <i class="fas fa-bars text-xl"></i>
                </button>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Breadcrumb -->
        <nav class="mb-6">
            <ol class="flex items-center space-x-2 text-sm text-gray-600">
                <li><a href="/" class="hover:text-gray-900">Trang chủ</a></li>
                <li><i class="fas fa-chevron-right text-xs"></i></li>
                <li><a href="/properties" class="hover:text-gray-900">Nhà/Phòng</a></li>
                <li><i class="fas fa-chevron-right text-xs"></i></li>
                <li class="text-gray-900 font-medium" id="breadcrumb-title">Chi tiết</li>
            </ol>
        </nav>

        <!-- Loading State -->
        <div id="loading" class="flex justify-center items-center py-20">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900 mx-auto mb-4"></div>
                <p class="text-gray-600">Đang tải thông tin...</p>
            </div>
        </div>

        <!-- Property Detail -->
        <div id="property-detail" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Left Column -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Image Gallery -->
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <div id="main-image" class="h-96 bg-gray-200"></div>
                        <div id="thumbnail-gallery" class="grid grid-cols-4 gap-2 p-4"></div>
                    </div>

                    <!-- Property Info -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex items-start justify-between mb-4">
                            <div>
                                <span id="property-type" class="inline-block px-3 py-1 bg-gray-100 text-gray-700 text-sm rounded-full mb-2"></span>
                                <h1 id="property-title" class="text-3xl font-bold text-gray-900 mb-2"></h1>
                                <p id="property-address" class="text-gray-600">
                                    <i class="fas fa-map-marker-alt mr-2"></i>
                                </p>
                            </div>
                            <div class="text-right">
                                <div id="property-price" class="text-3xl font-bold text-gray-900"></div>
                                <div class="text-sm text-gray-500">/ tháng</div>
                            </div>
                        </div>

                        <!-- Stats -->
                        <div class="grid grid-cols-3 gap-4 py-4 border-t border-b border-gray-200">
                            <div class="text-center">
                                <i class="fas fa-expand-arrows-alt text-gray-400 mb-1"></i>
                                <div id="property-area" class="font-semibold text-gray-900"></div>
                                <div class="text-sm text-gray-500">Diện tích</div>
                            </div>
                            <div class="text-center">
                                <i class="fas fa-bed text-gray-400 mb-1"></i>
                                <div id="property-bedrooms" class="font-semibold text-gray-900"></div>
                                <div class="text-sm text-gray-500">Phòng ngủ</div>
                            </div>
                            <div class="text-center">
                                <i class="fas fa-bath text-gray-400 mb-1"></i>
                                <div id="property-bathrooms" class="font-semibold text-gray-900"></div>
                                <div class="text-sm text-gray-500">Phòng tắm</div>
                            </div>
                        </div>

                        <!-- Description -->
                        <div class="mt-6">
                            <h2 class="text-xl font-bold text-gray-900 mb-3">Mô tả</h2>
                            <div id="property-description" class="text-gray-700 leading-relaxed"></div>
                        </div>

                        <!-- Amenities -->
                        <div class="mt-6">
                            <h2 class="text-xl font-bold text-gray-900 mb-3">Tiện nghi</h2>
                            <div id="property-amenities" class="grid grid-cols-2 md:grid-cols-3 gap-3"></div>
                        </div>
                    </div>

                    <!-- Map -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h2 class="text-xl font-bold text-gray-900 mb-4">
                            <i class="fas fa-map-marker-alt text-blue-500 mr-2"></i>
                            Vị trí trên bản đồ
                        </h2>
                        <div id="map"></div>
                        <p class="text-sm text-gray-600 mt-3">
                            <i class="fas fa-info-circle mr-2"></i>
                            Click và kéo để di chuyển bản đồ. Cuộn chuột để zoom in/out.
                        </p>
                    </div>
                </div>

                <!-- Right Column - Sidebar -->
                <div class="space-y-6">
                    <!-- Contact Card -->
                    <div class="bg-white rounded-xl shadow-sm p-6 sticky top-4">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Thông tin liên hệ</h3>
                        
                        <div id="landlord-info" class="mb-6">
                            <div class="flex items-center space-x-3 mb-4">
                                <img id="landlord-avatar" src="" alt="Landlord" class="w-12 h-12 rounded-full object-cover">
                                <div>
                                    <div id="landlord-name" class="font-semibold text-gray-900"></div>
                                    <div class="text-sm text-gray-500">Chủ nhà</div>
                                </div>
                            </div>
                            <div id="landlord-phone" class="flex items-center text-gray-700 mb-2">
                                <i class="fas fa-phone mr-3 text-gray-400"></i>
                            </div>
                            <div id="landlord-email" class="flex items-center text-gray-700">
                                <i class="fas fa-envelope mr-3 text-gray-400"></i>
                            </div>
                        </div>

                        <button class="w-full bg-gray-900 text-white py-3 rounded-lg hover:bg-gray-800 transition-colors mb-3">
                            <i class="fas fa-phone mr-2"></i>Gọi điện
                        </button>
                        <button class="w-full bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 transition-colors mb-3">
                            <i class="fas fa-envelope mr-2"></i>Gửi tin nhắn
                        </button>
                        <button class="w-full bg-white border-2 border-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-50 transition-colors">
                            <i class="fas fa-heart mr-2"></i>Lưu tin
                        </button>
                    </div>

                    <!-- Report Card -->
                    <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4">
                        <h4 class="font-semibold text-gray-900 mb-2">
                            <i class="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>
                            Báo cáo tin đăng
                        </h4>
                        <p class="text-sm text-gray-600 mb-3">Nếu bạn thấy tin đăng này có vấn đề, vui lòng báo cáo cho chúng tôi.</p>
                        <button class="text-sm text-yellow-700 font-medium hover:text-yellow-800">
                            Báo cáo ngay →
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error State -->
        <div id="error" class="hidden text-center py-20">
            <i class="fas fa-exclamation-circle text-6xl text-red-500 mb-4"></i>
            <h2 class="text-2xl font-bold text-gray-900 mb-2">Không tìm thấy bất động sản</h2>
            <p class="text-gray-600 mb-6">Bất động sản này không tồn tại hoặc đã bị xóa.</p>
            <a href="/" class="inline-block px-6 py-3 bg-gray-900 text-white rounded-lg hover:bg-gray-800">
                Về trang chủ
            </a>
        </div>
    </main>

    <!-- Footer Placeholder -->
    <div id="footer-placeholder"></div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""></script>
    <script src="/js/auth.js"></script>
    
    <script>
        // Load header and footer
        fetch('/views/partials/header.html')
            .then(res => res.text())
            .then(html => {
                document.getElementById('header-placeholder').innerHTML = html;
                // Initialize auth after header is loaded
                if (typeof checkAuth === 'function') checkAuth();
            })
            .catch(err => console.error('Error loading header:', err));

        fetch('/views/partials/footer.html')
            .then(res => res.text())
            .then(html => {
                document.getElementById('footer-placeholder').innerHTML = html;
            })
            .catch(err => console.error('Error loading footer:', err));

        // Get property ID from URL
        const propertyId = window.location.pathname.split('/').pop();

        // Load property data
        async function loadPropertyDetail() {
            try {
                const response = await fetch(`/api/properties/${propertyId}`);
                
                if (!response.ok) {
                    throw new Error('Property not found');
                }

                const result = await response.json();
                const property = result.data;

                // Hide loading, show content
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('property-detail').classList.remove('hidden');

                // Populate data
                populatePropertyData(property);
                initializeMap(property);
                
            } catch (error) {
                console.error('Error loading property:', error);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('error').classList.remove('hidden');
            }
        }

        function populatePropertyData(property) {
            // Title and basic info
            document.getElementById('breadcrumb-title').textContent = property.title;
            document.getElementById('property-title').textContent = property.title;
            document.getElementById('property-type').textContent = getPropertyTypeLabel(property.propertyType);
            
            // Address
            document.getElementById('property-address').innerHTML = `
                <i class="fas fa-map-marker-alt mr-2"></i>
                ${property.address.street}, ${property.address.ward}, ${property.address.district}, ${property.address.city}
            `;

            // Price
            const price = (property.price / 1000000).toFixed(1);
            document.getElementById('property-price').textContent = price + ' triệu';

            // Stats
            document.getElementById('property-area').textContent = property.area + 'm²';
            document.getElementById('property-bedrooms').textContent = property.bedrooms || 0;
            document.getElementById('property-bathrooms').textContent = property.bathrooms || 0;

            // Description
            document.getElementById('property-description').textContent = property.description;

            // Images
            if (property.images && property.images.length > 0) {
                const mainImage = document.getElementById('main-image');
                mainImage.innerHTML = `<img src="${property.images[0]}" alt="${property.title}" class="w-full h-full object-cover">`;
                
                const thumbnailGallery = document.getElementById('thumbnail-gallery');
                thumbnailGallery.innerHTML = property.images.map((img, index) => `
                    <img src="${img}" alt="Ảnh ${index + 1}" class="w-full h-24 object-cover rounded cursor-pointer hover:opacity-75" 
                         onclick="changeMainImage('${img}')">
                `).join('');
            }

            // Amenities
            const amenitiesContainer = document.getElementById('property-amenities');
            const amenities = property.amenities || [];
            if (amenities.length > 0) {
                amenitiesContainer.innerHTML = amenities.map(amenity => `
                    <div class="flex items-center text-gray-700">
                        <i class="fas fa-check-circle text-green-500 mr-2"></i>
                        ${amenity}
                    </div>
                `).join('');
            } else {
                amenitiesContainer.innerHTML = '<p class="text-gray-500 italic">Không có thông tin tiện nghi</p>';
            }

            // Landlord info
            if (property.landlord) {
                document.getElementById('landlord-name').textContent = property.landlord.name || 'Chủ nhà';
                document.getElementById('landlord-phone').innerHTML = `
                    <i class="fas fa-phone mr-3 text-gray-400"></i>
                    ${property.landlord.phone || 'Chưa cập nhật'}
                `;
                document.getElementById('landlord-email').innerHTML = `
                    <i class="fas fa-envelope mr-3 text-gray-400"></i>
                    ${property.landlord.email || 'Chưa cập nhật'}
                `;
                
                // Avatar
                const avatar = property.landlord.avatar || `https://ui-avatars.com/api/?name=${property.landlord.name}&background=random`;
                document.getElementById('landlord-avatar').src = avatar;
            }
        }

        function initializeMap(property) {
            if (!property.location || !property.location.coordinates || property.location.coordinates.length < 2) {
                document.getElementById('map').innerHTML = '<p class="text-center text-gray-500 py-20">Chưa có thông tin vị trí</p>';
                return;
            }

            const [lng, lat] = property.location.coordinates;

            // Create map
            const map = L.map('map').setView([lat, lng], 15);

            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(map);

            // Add marker
            const marker = L.marker([lat, lng]).addTo(map);
            marker.bindPopup(`
                <div class="text-center">
                    <strong class="text-gray-900">${property.title}</strong><br>
                    <span class="text-sm text-gray-600">${property.address.district}, ${property.address.city}</span>
                </div>
            `).openPopup();

            // Add circle
            L.circle([lat, lng], {
                color: '#3b82f6',
                fillColor: '#3b82f6',
                fillOpacity: 0.1,
                radius: 500
            }).addTo(map);
        }

        function changeMainImage(src) {
            document.getElementById('main-image').innerHTML = `<img src="${src}" alt="Main image" class="w-full h-full object-cover">`;
        }

        function getPropertyTypeLabel(type) {
            const types = {
                'phong-tro': 'Phòng trọ',
                'nha-nguyen-can': 'Nhà nguyên căn',
                'can-ho': 'Căn hộ',
                'chung-cu-mini': 'Chung cư mini',
                'homestay': 'Homestay'
            };
            return types[type] || type;
        }

        // Load property on page load
        loadPropertyDetail();
    </script>
</body>
</html>
