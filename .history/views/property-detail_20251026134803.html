<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi tiết phòng - HomeRent</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        html { scroll-behavior: smooth; }
        
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #6B7280;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #4B5563;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Loading -->
    <div id="loading" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-gray-800 mx-auto mb-4"></div>
            <p class="text-gray-600">Đang tải...</p>
        </div>
    </div>

    <!-- Header -->
    <div id="headerContainer"></div>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8 mt-20">
        <div id="propertyContent">
            <!-- Content will be loaded here -->
        </div>
    </main>

    <!-- Footer -->
    <div id="footerContainer"></div>

    <!-- Scripts -->
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""></script>
    
    <script src="/js/auth.js"></script>
    
    <script>
        // Load Header & Footer
        fetch('/partials/header.html')
            .then(res => res.text())
            .then(html => {
                document.getElementById('headerContainer').innerHTML = html;
                initializeHeader();
            });

        fetch('/partials/footer.html')
            .then(res => res.text())
            .then(html => {
                document.getElementById('footerContainer').innerHTML = html;
            });

        // Get property ID from URL
        const propertyId = window.location.pathname.split('/').pop();

        // Fetch property details
        async function loadPropertyDetails() {
            try {
                const response = await fetch(`/api/properties/${propertyId}`);
                
                if (!response.ok) {
                    throw new Error('Property not found');
                }

                const result = await response.json();
                const property = result.data;

                renderPropertyDetails(property);
                
                // Hide loading
                document.getElementById('loading').style.display = 'none';
                
            } catch (error) {
                console.error('Error loading property:', error);
                document.getElementById('loading').innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-exclamation-circle text-6xl text-red-500 mb-4"></i>
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">Không tìm thấy bất động sản</h2>
                        <p class="text-gray-600 mb-4">Bất động sản này không tồn tại hoặc đã bị xóa.</p>
                        <a href="/" class="px-6 py-3 bg-gray-800 text-white rounded-lg hover:bg-gray-700">
                            Về trang chủ
                        </a>
                    </div>
                `;
            }
        }

        function renderPropertyDetails(property) {
            const price = (property.price / 1000000).toFixed(1);
            const deposit = property.deposit ? (property.deposit / 1000000).toFixed(1) : 0;
            
            const html = `
                <!-- Breadcrumb -->
                <nav class="text-sm mb-6">
                    <a href="/" class="text-gray-600 hover:text-gray-900">Trang chủ</a>
                    <span class="mx-2">/</span>
                    <a href="/properties" class="text-gray-600 hover:text-gray-900">Cho thuê</a>
                    <span class="mx-2">/</span>
                    <span class="text-gray-900">${property.title}</span>
                </nav>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Left: Images & Details -->
                    <div class="lg:col-span-2 space-y-6">
                        <!-- Images Gallery -->
                        <div class="bg-white rounded-xl overflow-hidden shadow-sm">
                            <div class="relative h-96">
                                <img id="mainImage" 
                                     src="${property.images?.[0] || '/images/property-placeholder.jpg'}" 
                                     alt="${property.title}"
                                     class="w-full h-full object-cover">
                                <div class="absolute top-4 left-4">
                                    <span class="px-4 py-2 bg-gray-800 text-white text-sm rounded-full">
                                        ${getPropertyTypeLabel(property.propertyType)}
                                    </span>
                                </div>
                                <div class="absolute top-4 right-4">
                                    <span class="px-4 py-2 ${property.status === 'available' ? 'bg-green-500' : 'bg-red-500'} text-white text-sm rounded-full">
                                        ${property.status === 'available' ? 'Còn trống' : 'Đã thuê'}
                                    </span>
                                </div>
                            </div>
                            ${property.images && property.images.length > 1 ? `
                            <div class="p-4 grid grid-cols-4 gap-2">
                                ${property.images.slice(0, 4).map((img, i) => `
                                    <img src="${img}" 
                                         alt="Ảnh ${i+1}"
                                         class="h-24 w-full object-cover rounded-lg cursor-pointer hover:opacity-75 transition-opacity"
                                         onclick="document.getElementById('mainImage').src='${img}'">
                                `).join('')}
                            </div>
                            ` : ''}
                        </div>

                        <!-- Property Info -->
                        <div class="bg-white rounded-xl p-6 shadow-sm">
                            <h1 class="text-3xl font-bold text-gray-900 mb-4">${property.title}</h1>
                            
                            <div class="flex items-center text-gray-600 mb-4">
                                <i class="fas fa-map-marker-alt mr-2"></i>
                                <span>${property.address?.street}, ${property.address?.ward}, ${property.address?.district}, ${property.address?.city}</span>
                            </div>

                            <div class="grid grid-cols-3 gap-4 mb-6">
                                <div class="text-center p-4 bg-gray-50 rounded-lg">
                                    <i class="fas fa-expand-arrows-alt text-2xl text-gray-800 mb-2"></i>
                                    <div class="text-sm text-gray-600">Diện tích</div>
                                    <div class="text-lg font-bold text-gray-900">${property.area}m²</div>
                                </div>
                                <div class="text-center p-4 bg-gray-50 rounded-lg">
                                    <i class="fas fa-bed text-2xl text-gray-800 mb-2"></i>
                                    <div class="text-sm text-gray-600">Phòng ngủ</div>
                                    <div class="text-lg font-bold text-gray-900">${property.bedrooms || 0}</div>
                                </div>
                                <div class="text-center p-4 bg-gray-50 rounded-lg">
                                    <i class="fas fa-bath text-2xl text-gray-800 mb-2"></i>
                                    <div class="text-sm text-gray-600">Phòng tắm</div>
                                    <div class="text-lg font-bold text-gray-900">${property.bathrooms || 0}</div>
                                </div>
                            </div>

                            <div class="border-t pt-6">
                                <h2 class="text-xl font-bold text-gray-900 mb-4">Mô tả</h2>
                                <p class="text-gray-600 whitespace-pre-line">${property.description}</p>
                            </div>

                            ${property.amenities && property.amenities.length > 0 ? `
                            <div class="border-t pt-6 mt-6">
                                <h2 class="text-xl font-bold text-gray-900 mb-4">Tiện nghi</h2>
                                <div class="grid grid-cols-2 gap-3">
                                    ${property.amenities.map(amenity => `
                                        <div class="flex items-center text-gray-700">
                                            <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                            <span>${amenity}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            ` : ''}
                        </div>

                        <!-- Map -->
                        <div class="bg-white rounded-xl p-6 shadow-sm">
                            <h2 class="text-xl font-bold text-gray-900 mb-4">
                                <i class="fas fa-map-marker-alt text-blue-500 mr-2"></i>
                                Vị trí
                            </h2>
                            <div id="propertyMap" style="height: 400px; border-radius: 0.5rem;"></div>
                        </div>
                    </div>

                    <!-- Right: Price & Contact -->
                    <div class="lg:col-span-1">
                        <div class="bg-white rounded-xl p-6 shadow-sm sticky top-24 space-y-6">
                            <div>
                                <div class="text-3xl font-bold text-gray-900">${price} triệu</div>
                                <div class="text-gray-600">/tháng</div>
                                ${deposit > 0 ? `<div class="text-sm text-gray-500 mt-2">Đặt cọc: ${deposit} triệu</div>` : ''}
                            </div>

                            <div class="border-t pt-4">
                                <div class="space-y-3 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Loại hình:</span>
                                        <span class="font-medium text-gray-900">${getPropertyTypeLabel(property.propertyType)}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Trạng thái:</span>
                                        <span class="font-medium ${property.status === 'available' ? 'text-green-600' : 'text-red-600'}">
                                            ${property.status === 'available' ? 'Còn trống' : 'Đã thuê'}
                                        </span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Mã tin:</span>
                                        <span class="font-medium text-gray-900">#${property._id.slice(-8)}</span>
                                    </div>
                                </div>
                            </div>

                            <div class="border-t pt-4 space-y-3">
                                <button class="w-full px-6 py-3 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition-colors">
                                    <i class="fas fa-phone mr-2"></i>
                                    Liên hệ ngay
                                </button>
                                <button class="w-full px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                                    <i class="fas fa-calendar-check mr-2"></i>
                                    Đặt lịch xem phòng
                                </button>
                                <button class="w-full px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                                    <i class="far fa-heart mr-2"></i>
                                    Lưu tin
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('propertyContent').innerHTML = html;

            // Initialize map
            if (property.location?.coordinates && property.location.coordinates.length === 2) {
                const [lng, lat] = property.location.coordinates;
                initMap(lat, lng, property.title);
            }
        }

        function initMap(lat, lng, title) {
            const map = L.map('propertyMap').setView([lat, lng], 15);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(map);

            const marker = L.marker([lat, lng]).addTo(map);
            marker.bindPopup(`<strong>${title}</strong>`).openPopup();

            L.circle([lat, lng], {
                color: '#3b82f6',
                fillColor: '#3b82f6',
                fillOpacity: 0.1,
                radius: 500
            }).addTo(map);
        }

        function getPropertyTypeLabel(type) {
            const types = {
                'phong-tro': 'Phòng trọ',
                'nha-nguyen-can': 'Nhà nguyên căn',
                'can-ho': 'Căn hộ',
                'chung-cu-mini': 'Chung cư mini',
                'homestay': 'Homestay'
            };
            return types[type] || type;
        }

        function initializeHeader() {
            // Initialize header functionality (from main.js)
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const mobileMenu = document.getElementById('mobileMenu');
            
            if (mobileMenuBtn && mobileMenu) {
                mobileMenuBtn.addEventListener('click', () => {
                    mobileMenu.classList.toggle('hidden');
                });
            }
        }

        // Load property on page load
        loadPropertyDetails();
    </script>

    <!-- AI Chatbot Widget -->
    <link rel="stylesheet" href="/css/chatbot.css">
    <script src="/js/chatbot.js"></script>
</body>
</html>
